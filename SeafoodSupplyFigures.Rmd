---
title: "Part 3. UK seafood supplies"
author: "AL"
date: "2023-03-10"
output: powerpoint_presentation
---

### Preparation 

```{r Load libraries, include = FALSE}
# Load packages
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(plyr) # joins multiple data frames together
library(ggplot2) # makes plots fancier
library(scales) # displays integers on the axis
library(ggthemes) # contains extra themes, scales and functions for and related to ggplot2
library(gridExtra)
library(cowplot) # Plots two figures one output

```


```{r Edit chunk settings, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warninf = FALSE, 
  fig.height = 9, 
  fig.width = 16
)
```


```{r Setup default for figures, include=FALSE}
# Set default presentation of figures
theme_set(theme_bw()%+replace%
            theme(
              title = element_text(size = 26), 
              text = element_text(size = 30), 
              axis.text = element_text(size = 24, colour = "gray40"), 
              legend.key.size = unit(1.2, "cm"), 
              legend.title = element_text(size = 26), 
              legend.text = element_text(size = 24),
              panel.grid.major = element_line(colour= "gray40", linetype = "dotted", linewidth = 0.9), 
              panel.grid.minor = element_line(colour = "gray70", linetype = "dotted", linewidth = 0.7)
            ))
# instead of "size" can also use "linewidth"
```


```{r Set colour-blind palette}
# Colour-blind friendly palette with grey. Try to keep the order (http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette)
cbPalette <- c( "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")
# production, imports, exports, purchases, consumption 
#consumption, exports, imports, production, purchases, supplies

# Colours will be allocated in commodity alphabetical order. 
```


```{r Load file path, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```


```{r Specify the desired file path}
filepath <- paste(data_dir,"ProcessedData", sep = "") 
# note we are able to change this to another file e.g. saving the output
```

```{r Load the database}
# Load database 
df_UK_population <- vroom(file=paste(filepath,"UKPopulation_ONS_PreliminaryCleaned.csv", sep="/"), na = c("NA"))
```



```{r Specify the desired file path}
filepath <- paste(data_dir,"RawData/csv-files", sep = "") 
```

```{r Load the database}
# Load consumption data
df_UK_totSeafood_PC <- vroom(file=paste(filepath,"NDNS_UK_TotalSeafood_NDNS_PCW.csv", sep="/"), na = c("NA"))
```



```{r Specify the desired file path}
filepath <- paste(data_dir,"Outputs", sep = "") 
# note we are able to change this to another file e.g. saving the output
```

```{r Load the database}
# Load database 
df_UK_seafoodDB <- vroom(file=paste(filepath,"Seafood-database_preliminary.csv", sep="/"), na = c("NA"))
```


Remove products for non-human consumption nor are included in the dietary recommendations 

```{r Final clean}
# Check the unique species types
unique(df_UK_seafoodDB$SpeciesType)

# Remove species type products not included in dietary recommendations e.g. "Fish meal", "white fish", "fish oil", "Seaweed and other algae". Remove products for non-human consumption. Remove 2019 data
df_UK_seafoodDB_food <- subset(df_UK_seafoodDB, SpeciesType != "Fish oil" & SpeciesType != "Seaweed and other algae" & Species != "Fishmeal" & Species != "Caviar, livers and roes" & Species != "White fish" & Species != "Surimi" & Year != 2019)
```


```{r Change structure of the data frame}
# See pivot_wider()/ spread() command in tidyverse to change structure. 
# See dplyr cheat sheet.

# Simplify data set and select desired columns 
df_UK_seafoodDB_food_spec <- df_UK_seafoodDB_food[c("Species", "SpeciesType", "SACN", "Year", "Commodity", "Value" )]

# Aggregate value by commodity, year and species (production data composed of aquaculture and wild capture)
df_UK_seafoodDB_food_simp <- aggregate(Value ~ Commodity + Year + Species + SpeciesType + SACN, data = df_UK_seafoodDB_food_spec, sum)

# Make data frame wide and short
df_UK_seafoodDB_short <- df_UK_seafoodDB_food_simp %>%
  pivot_wider(names_from = Commodity, values_from = Value)
```


```{r Combine database with UK population data}
# Merge seafood database with UK population data
df_UK_seafoodDB_Pop <- merge(df_UK_seafoodDB_short, df_UK_population, by = "Year")

# Simplify data set and select desired columns 
df_UK_seafoodDB_capita <- df_UK_seafoodDB_Pop[c("Species", "SpeciesType", "SACN", "Year", "Production",
                                                   "Exports","Imports", "Consumption","Purchases",
                                                   "UKPOP")]

colnames(df_UK_seafoodDB_Pop)
str(df_UK_seafoodDB_Pop)
df_UK_seafoodDB_capita

```


```{r Calculate seafood supplies}
# Convert NA to zeros (otherwise supplies cannot be calculated)
df_UK_seafoodDB_capita[is.na(df_UK_seafoodDB_capita)] <- 0

# Calculate seafood supplies
df_UK_seafoodDB_capita$Supplies <- (df_UK_seafoodDB_capita$Production + df_UK_seafoodDB_capita$Imports) - df_UK_seafoodDB_capita$Exports
```


```{r Calculate seafood supplies (g/capita/week)}
# Calculate seafood supplies per capita
df_UK_seafoodDB_capita$Supplies_capWeek <- (df_UK_seafoodDB_capita$Supplies/ df_UK_seafoodDB_capita$UKPOP)/52

# Calculate seafood consummed per capita
df_UK_seafoodDB_capita$Consumption_capWeek <- (df_UK_seafoodDB_capita$Consumption/ df_UK_seafoodDB_capita$UKPOP)/52

```



### Creating figures in ggplot


### Figure. Average UK seafood supply (g/capita/week) between 2009 and 2018  

```{r Total national seafood supplied and consumed (g/capita/week) between 2009 and 2018}

# Sum annual UK seafood supplies and intake per capita 
df_UK_supplies_tot <- aggregate(Supplies_capWeek ~ Year, data = df_UK_seafoodDB_capita, sum)
#df_UK_intake_tot <- aggregate(Consumption_capWeek ~ Year, data = df_UK_seafoodDB_capita, sum)

# Rename data frame variables 
names(df_UK_supplies_tot) <- c("Year", "Value")
names(df_UK_totSeafood_PC) <- c("Year", "Value")

# Add additional variable
df_UK_supplies_tot$Commodity <- "Supplies"
df_UK_totSeafood_PC$Commodity <- "Consumption"

# rbind data frames
df_UK_supplies_intake_tot<- rbind(df_UK_supplies_tot, df_UK_totSeafood_PC)

# Plot total seafood supplied and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_supplies_intake_tot, aes(Year, Value, fill= Commodity)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 2)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  geom_hline(yintercept = 140, linetype = "twodash", color = "navyblue", linewidth = 2) +
  scale_fill_manual(values = c("#E69F00", "#009E73")) +
  theme(legend.title = element_blank()) 



```



### Figure. Comparing seafood supplies (g/capita/week) with dietary recommendations in the UK and Scotland 

```{r Compare SACN supplies with dietary recommendations}

# Sum UK seafood supplies per capita by SACN
df_UK_supplies_SACN <- aggregate(Supplies_capWeek ~ SACN + Year, data = df_UK_seafoodDB_capita, sum)
# Average UK seafood supplies per capita for each year
df_UK_supplies_SACN_avg <- aggregate(Supplies_capWeek ~ SACN, data = df_UK_supplies_SACN, mean)

# Create a new varible
df_UK_supplies_SACN_avg$Commodity <- "Species type"


# a) Lean and oily fish only
df_UK_supplies_SACN_avg_LO <- subset(df_UK_supplies_SACN_avg, SACN == "Lean" | SACN == "Oily")

# Plot average seafood supply (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_supplies_SACN_avg_LO, aes(y = Supplies_capWeek, x = Commodity, fill = SACN)) +
  geom_bar(position = "stack", stat = "identity", color = "black", width = 0.5) + 
  scale_y_continuous(name = "Average seafood supplies (g/capita/week)", limits = c(0,300)) +
  scale_fill_manual(values = c("#CC79A7", "#D55E00"))+
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2.0) +
  geom_hline(yintercept = 140, linetype = "dashed", color = "blue", linewidth = 2.0)



# b) Lean, oily and shellfish
df_UK_supplies_SACN_avg_LOS <- subset(df_UK_supplies_SACN_avg, SACN == "Lean" | SACN == "Oily" | 
                                       SACN == "Shellfish")

# Convert variable to factor to specify order
df_UK_supplies_SACN_avg_LOS$SACN <- factor(df_UK_supplies_SACN_avg_LOS$SACN, levels = c("Shellfish", "Lean", "Oily"))

# Plot average seafood supply (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_supplies_SACN_avg_LOS, aes(y = Supplies_capWeek, x = Commodity, fill = SACN)) +
  geom_bar(position = "stack", stat = "identity", color = "black", width = 0.5) + 
  scale_y_continuous(name = "Average seafood supplies (g/capita/week)", limits = c(0,300)) +
  scale_fill_manual(values = c("#999999","#CC79A7", "#D55E00"))+
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2.0) +
  geom_hline(yintercept = 140, linetype = "dashed", color = "blue", linewidth = 2.0)


```


```{r Plot figures side-by-side}
# Ensure y-axis values are on the same scale
# UK
#plot_UKRec <- ggplot(df_UK_supplies_SACN_avg, aes(SACN, Supplies_capWeek)) +
#  geom_col(fill = "#D55E00", color = "black") +
  #scale_x_discrete(guide = guide_axis(angle = 90), name = "") + 
#  scale_y_continuous(name = "Seafood supplies (g/capita/week)", limits = c(0,300)) +
#  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 1.0)

# Scotland 
#plot_ScotRec <- ggplot(df_UK_supplies_SACN_avg, aes(SACN, Supplies_capWeek)) +
#  geom_col(fill = "#D55E00", color = "black") +
  #scale_x_discrete(guide = guide_axis(angle = 90), name = "") + 
#  scale_y_continuous(name = "Seafood supplies (g/capita/week)", limits = c(0,300)) +
#  geom_hline(yintercept = 140, linetype = "dashed", color = "red", linewidth = 1.0)

# Combine plots
#plot_grid(plot_UKRec, plot_ScotRec)
```



```{r Create stacked bar plot for each recommendation}
# Ensure y-axis values are on the same scale
#df_UK_supplies_SACN_avg$loc <- "UK"
#df_Scot_supplies_SACN_avg <- df_UK_supplies_SACN_avg
#df_Scot_supplies_SACN_avg$loc <- "Scotland"
#df_both_supplies_SACN_avg <- rbind(df_Scot_supplies_SACN_avg,df_UK_supplies_SACN_avg)


# Both
#ggplot(df_both_supplies_SACN_avg, aes(y = Supplies_capWeek, x= Type)) +
#  geom_bar(aes(fill = SACN), position = "stack", stat = "identity", fill = cbPalette) +
#  scale_y_continuous(name = "Seafood supplies (g/capita/week)", limits = c(0,300)) +
#  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 1.0) + 
#  facet_wrap(~loc)
# Able to use facetwrap() to change the title of the strip
```


```{r Stack bar chart of seafood types}
# b) Oily, lean and shellfish only
# Subset lean and oily fish only 
#df_UK_SACN_SLO_avg <- subset(df_UK_supplies_SACN_avg, SACN == "Lean" | SACN == "Oily" | SACN == "Shellfish")
#df_UK_SACN_SLO_avg$Type <- "Seafood type"

# Convert variable to factor to specify order
#df_UK_SACN_SLO_avg$SACN <- factor(df_UK_SACN_SLO_avg$SACN, levels = c("Shellfish", "Lean", "Oily"))

# Plot barchat for Scotland
#plot_SLO_Scot <- ggplot(df_UK_SACN_SLO_avg, aes(y = Supplies_capWeek, x= Type, fill = SACN))+
#  geom_bar(position = "stack", stat = "identity", color = "black", fill = c("#D55E00", "#CC79A7", "#999999")) +
##  scale_y_continuous(name = "Seafood supplies (g/capita/week)", limits = c(0,300)) +
#  geom_hline(yintercept = 140, linetype = "dashed", color = "red", linewidth = 1.0) 

#plot_SLO_Scot <- ggplot(df_UK_SACN_SLO_avg, aes(y = Supplies_capWeek, x= Type, fill = SACN))+
#  geom_bar(position = "stack", stat = "identity", color = "black") + 
#  scale_color_brewer(palette = cbPalette) +
#  scale_y_continuous(name = "Seafood supplies (g/capita/week)", limits = c(0,300)) +
#  geom_hline(yintercept = 140, linetype = "dashed", color = "red", linewidth = 1.0) 

# Plot barchat for UK
#plot_SLO_UK <-ggplot(df_UK_SACN_SLO_avg, aes(y = Supplies_capWeek, x= Type, fill = SACN))+
#  geom_bar(position = "stack", stat = "identity", color = "black", fill = c("#D55E00", "#CC79A7", "#999999")) +
#  scale_y_continuous(name = "Seafood supplies (g/capita/week)", limits = c(0,300)) +
#  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 1.0) 

#plot_grid(plot_SLO_Scot, plot_SLO_UK)

```





### Figure 4. UK seafood variabilty (g/capita/week) betwen 2008 and 2019

```{r UK seafood variabilty}
# Boxplot of seafood supplies (g/capita/week)
ggplot(df_UK_seafoodDB_capita, aes(Species, Supplies_capWeek)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90), name = "") + 
  scale_y_continuous(name = "Seafood supplies (g/capita/week)") +
  geom_hline(yintercept = 0, linetype="dashed", color = "orange", linewidth = 1.0)


# Boxplot of seafood supplies (g)
ggplot(df_UK_seafoodDB_capita, aes(Species, Supplies)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90), name = "") + 
  scale_y_continuous(name = "Seafood supplies (g)") +
  geom_hline(yintercept = 0, linetype="dashed", color = "orange", linewidth = 1.0)

# Set y axis scale to logarithmic. Allows us to explore the values aggregated at 0 and those at significantly higher values
ggplot(df_UK_seafoodDB_capita, aes(Species, Supplies)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90), name = "") + 
  scale_y_continuous(name = "Seafood supplies (g)") +
  geom_hline(yintercept = 0, linetype="dashed", color = "orange", linewidth = 1.0) +
  scale_y_log10(breaks = c(seq(1,9,1), seq(10,90,10), seq(100,900,100), seq(1000,10000,1000)),
                labels = c("1","","","","","","","","","10" ,"","","","","","","","","100"
                           ,"","","","","","","","","1000" ,"","","","","","","","","10000")) +
  theme(panel.gird.minor = element_blank())

```


### Figure 5. Relating national seafood supplies to dietary recommendations in 2018 

```{r Subset desired seafood species in 2018 only}
# Subset 2018 data only
df_UK_seafoodDB_capita_2018 <- subset(df_UK_seafoodDB_capita, Year == 2018)

# Identify seafood species 
unique(df_UK_seafoodDB_capita$Species)

# Subset specific species of interest
df_UK_SOI_capita_2018 <- subset(df_UK_seafoodDB_capita_2018, Species == "Haddock" | 
                                  Species == "Mackerel" | Species == "Salmon" | Species == "Tuna" | 
                                  Species == "Whiting"| Species == "Shrimp"| Species == "Herring" |
                                  Species == "Halibut"| Species == "Plaice" | Species == "Cockle" | 
                                  Species == "Seabass" | Species == "Blue whiting" | 
                                  Species == "Trout" | Species ==  "Octopus" | Species == "Cod")
```




```{r National seafood supplies for 2018 only (g/capita/week)}
# Simplify data set and select desired columns 
df_UK_SOI_capita_2018_specific <- df_UK_SOI_capita_2018[c("Species", "SpeciesType", "SACN", "Consumption_capWeek", "Supplies_capWeek")]

# Change structure of the data set 
df_UK_SOI_capita_2018_short <- melt(df_UK_SOI_capita_2018_specific, id.vars = c("Species", "SpeciesType", "SACN"), variable.name = "Commodity", value.name = "Value")

df_UK_SOI_capita_2018$Consumption_capWeek
df_UK_SOI_capita_2018_new <- df_UK_SOI_capita_2018[c("Species","Supplies_capWeek")]

# Plot total seafood supplied and consumed (g/capita/week) between 2009 and 2018 
ggplot(df_UK_SOI_capita_2018_new, aes(x= reorder(Species, -Supplies_capWeek), Supplies_capWeek))+ #fill= Commodity)) +
  geom_bar(position = "dodge", stat= "identity", color = "black", fill ="#009E73") +
  scale_x_discrete(guide = guide_axis(angle = 45), name = "") +
  scale_y_continuous(name = "National seafood supplies (g/capita/week)", limits = c(0,35)) +
  scale_fill_manual(values = "#009E73") +
  theme(legend.position="none") # removes legend
  #theme(legend.title = element_blank())
```



```{r National seafood supplies for 2018 only (g/country/year)}
# Select desired columns 
df_UK_SOI_2018_specific <- df_UK_SOI_capita_2018[c("Species", "SpeciesType", "SACN", "Consumption", "Supplies")]

# Change structure of the data set 
df_UK_SOI_2018_grams <- melt(df_UK_SOI_2018_specific, id.vars = c("Species", "SpeciesType", "SACN"), variable.name = "Commodity", value.name = "Value")

# Plot total seafood supplied and consumed (g/capita/week) between 2009 and 2018 
ggplot(df_UK_SOI_2018_grams, aes(Species, Value, fill= Commodity)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_x_discrete(guide = guide_axis(angle = 45), name = "") +
  scale_y_continuous(name = "National seafood supplies (g)") +
  scale_fill_manual(values = c("#E69F00", "#009E73")) +
  theme(legend.position="none") # removes legend
  #theme(legend.title = element_blank()) 

```


