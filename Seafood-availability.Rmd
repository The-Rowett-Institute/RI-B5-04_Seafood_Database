---
title: "Part 3. Initial exploration. RI-B5-04: UK seafood supply chains"
author: "A.Lofstedt"
date: "18/01/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Part 3: Initial exploration of the data set

This R markdown document shows the initial exploration of the data set.  Initial exploration includes calculating net seafood supplies for the UK over the past 9 years. UK seafood supplies between 2009 and 2018 were derived from data on imports and production (from both capture fisheries and aquaculture), accounting for exports. UK fish dietary recommendations were compared with national seafood supplies. Seafood supplies were then compared to UK seafood purchasing and consumption data. Analyses were calculated in both kilograms and g per capita per week, to facilitate comparisons with dietary guidelines.   

### Preparation 

```{r Load libraries, include=FALSE}
# Load packages
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(plyr) # joins multiple data frames together
library(ggplot2)
library(scales) # displays integers on the axis

```

```{r Load file path, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```

```{r Specify the desired file path}
filepath <- paste(data_dir,"Outputs", sep="") 
# note we are able to change this to another file e.g. saving the output
```


```{r Load the database}
# Load database 
df_UK_seafoodDB <- vroom(file=paste(filepath,"Seafood-database_preliminary.csv", sep="/"), na = c("NA"))

# Check the structure 
str(df_UK_seafoodDB)

```


Remove products for non-human consumption nor are included in the dietary recommendations 

```{r Final clean}
# Check the unique species types
unique(df_UK_seafoodDB$SpeciesType)

# Remove species type products not included in dietary recommendations e.g. "Fish meal", "white fish", "fish oil", "Seaweed and other algae". Remove products for non-human consumption. Remove 2019 data
df_UK_seafoodDB_food <- subset(df_UK_seafoodDB, SpeciesType != "Fish oil" & SpeciesType != "Seaweed and other algae" & Species != "Fishmeal" & Species != "Caviar, livers and roes" & Species != "White fish" & Species != "Surimi" & Year !=2019)

# Check their removal
unique(df_UK_seafoodDB_food$SpeciesType)
unique(df_UK_seafoodDB_food$Species)
unique(df_UK_seafoodDB_food$Year)


#df_UK_seafoodSpecies <-df_UK_seafoodDB[grep("Other", df_UK_seafoodDB$Species), ]

```



## Exploratory plots

```{r Bar plot displaying weight for each species/type by commodity}
# Create stacked bar plot displaying weight for each species, by commodity. 
ggplot(df_UK_seafoodDB_food, aes(fill = Commodity, y = Value, x = Species)) + 
  geom_bar(position='stack', stat='identity') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Plot bars side by side
ggplot(df_UK_seafoodDB_food, aes(x = Species, y = Value, fill = Commodity)) +
  geom_col(position = "dodge")

# Create stacked bar plot displaying weight for each species type, by commodity. 
ggplot(df_UK_seafoodDB_food, aes(fill = Commodity, y = Value, x = SpeciesType)) + 
  geom_bar(position='stack', stat='identity') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(df_UK_seafoodDB_food, aes(x = SpeciesType, y = Value, fill = Commodity)) +
  geom_col(position = "dodge") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Create stacked bar plot displaying weight for each SACN, by commodity. 
ggplot(df_UK_seafoodDB_food, aes(fill = Commodity, y = Value, x = SACN)) + 
  geom_bar(position='stack', stat='identity') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# Aggregate seafood value per year per commodity
df_UK_seafood_sum <- aggregate(Value ~ Year + Commodity, data = df_UK_seafoodDB_food, sum)

# Plot commodity values per year 
ggplot(df_UK_seafood_sum, aes(x = Year, y = Value)) + 
  geom_line(aes(color = Commodity)) + 
  scale_color_manual(name='Commodity', labels=c('production', 'imports', 'exports', 'purchases', 'consumption'),
                     values=c('red', 'purple', 'steelblue', 'orange', 'green')) + 
  scale_x_continuous(breaks= pretty_breaks())


```



```{r Explore data by commodity}
# Subset production data
df_UK_seafood_prod <- subset(df_UK_seafoodDB_food, Commodity == "Production")

# Box plot of UK seafood production, by species 
boxplot(Value ~ Species, data = df_UK_seafood_prod, ylab= "Production (g)", xlab = "", las = 3)

# Box plot of UK seafood production, by SACN 
boxplot(Value ~ SACN, data = df_UK_seafood_prod, ylab= "Production (g)", xlab = "", las = 3)

ggplot(df_UK_seafood_prod, aes(SACN, Value)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90)) 

# Group production values by SACN values
bwplot(Value ~ Species | SACN, data = df_UK_seafood_prod, las = 3)

ggplot(df_UK_seafood_prod, aes(Species, Value)) +
    geom_point() +
    facet_wrap(~ SACN) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


```{r For AL when changing the data}
# Load UK capture production data (UK and foreign vessels landings into the UK)
df_allLandingsintoUK_NS_clean_data <- vroom(file = paste(filepath,"UKVesslesLandingsintoUKAbroad_MMO_PreliminaryCleaned.csv", sep = "/"))

# Load UK aquaculture production data 
df_aquaProd_Eurostat_clean_data <- vroom(file = paste(filepath,"AquacultureData_Eurostat_PreliminaryCleaned.csv", sep = "/"))

# Merge data frames
df_UK_seafood_prod <- rbind(df_allLandingsintoUK_NS_clean_data, df_aquaProd_Eurostat_clean_data)

```




```{r Subeset database commodities}
# Subset commodities (long and thin)
df_UK_seafood_prod <- subset(df_UK_seafoodDB_food, Commodity == "Production")
df_UK_seafood_imp <- subset(df_UK_seafoodDB_food, Commodity == "Imports")
df_UK_seafood_exp <- subset(df_UK_seafoodDB_food, Commodity == "Exports")
df_UK_seafood_purch <- subset(df_UK_seafoodDB_food, Commodity == "Purchase")
df_UK_seafood_consump <- subset(df_UK_seafoodDB_food, Commodity == "Consumption")

# Join commodities (short and wide) by species and year 
df_UK_seafoodPos <- merge(df_UK_seafood_prod, df_UK_seafood_imp, by = c("Species", "Year"), all= TRUE)
df_UK_supplies <- merge(df_UK_seafoodPos, df_UK_seafood_exp, by = c("Species", "Year"), all= TRUE)
df_UK_sup_purch <- merge(df_UK_supplies, df_UK_seafood_purch, by = c("Species", "Year"), all= TRUE)
df_UK_sup_purch_cons <- merge(df_UK_sup_purch, df_UK_seafood_consump, by = c("Species", "Year"), all= TRUE)


# Create new data frame with desired variables 
colnames(df_UK_supplies)

# Select desired variables 
df_UK_supplies_short<- df_UK_supplies[c("Species", "SpeciesType.x", "SACN.x", "Value.x", "Value.y", "Value", "Year")]

# Rename variables
names(df_UK_supplies_short) <- c("Species", "SpeciesType", "SACN", "Prod", "Imp", "Exports", "Year")

# Convert NA to zeros (otherwise availability cannot be calculated)
df_UK_supplies_short[is.na(df_UK_supplies_short)] <- 0

# Calculate seafood supplies
df_UK_supplies_short$supplies <- (df_UK_supplies_short$Prod + df_UK_supplies_short$Imp) - df_UK_supplies_short$Exports

```


```{r Boxplot of seafood supplies}
# Box plot of UK seafood supplies
boxplot(supplies ~ Species, data = df_UK_supplies_short, col = "lightgray", 
        ylab = "Seafood supplied to the UK (grams)", xlab = "", las = 3, cex.axis = 1.0)

ggplot(df_UK_supplies_short, aes(Species, supplies)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90)) + 
  geom_hline(yintercept = 0, linetype="dashed", color = "red", size = 1.0)

ggplot(df_UK_supplies_short, aes(SpeciesType, supplies)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90)) 

#ggplot(df_UK_supplies_short, aes(Species, supplies)) +
#    geom_point() +
#    facet_wrap(~ SACN) + 
#  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# add in horizontal line marking dietary recommendation
#abline(h = 0, col = "darkred")
```


```{r Boxplot of seafood supplies by}
# Subset data frame according to SACN classification
df_UK_supplies_oily <- subset(df_UK_supplies_short, SACN == "Oily")
df_UK_supplies_lean <- subset(df_UK_supplies_short, SACN == "Lean")
df_UK_supplies_shellfish <- subset(df_UK_supplies_short, SACN == "Shellfish")

# Plot oily fish only 
ggplot(df_UK_supplies_oily, aes(Species, supplies)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90)) + 
  geom_hline(yintercept = 0, linetype="dashed", color = "red", size = 1.0)

# Plot lean fish only 
ggplot(df_UK_supplies_lean, aes(Species, supplies)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90)) + 
  geom_hline(yintercept = 0, linetype="dashed", color = "red", size = 1.0)

# Plot shellfish fish only 
ggplot(df_UK_supplies_shellfish, aes(Species, supplies)) +
  geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 90)) + 
  geom_hline(yintercept = 0, linetype="dashed", color = "red", size = 1.0) # Change line type and color

```


```{r Plot UK seafood supply (g) between 2009 and 2018}
# Aggregate seafood supplies per year
annual_seafood <- aggregate(supplies ~ Year, data = df_UK_supplies_short, sum)

# Plot seafood supplies per year (between 2009 and 2018)
annual_seafoods <- plot(supplies ~ Year, data = annual_seafood, pch= 20, type = "l", cex.axis = 1.0, cex.lab = 1.5, ylab = "Seafood supplies (g)", xlab = "Year")

# Create stacked bar plot displaying weight for each SACN, by commodity. 
ggplot(df_UK_seafoodDB_food, aes(fill = Commodity, y = Value, x = SACN)) + 
  geom_bar(position='stack', stat='identity') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```




```{r Plot annual UK seafood supply (g/capita/week) between 2009 and 2018}
# Calculate seafood supplies per person per week

# Plot annual seafood availability between 2009 and 2018
annual_seafoods <- plot(supplies ~ Year, data = annual_seafood, pch= 20, type = "l", cex.axis = 1.0, cex.lab = 1.5, ylab = "Seafood available", xlab = "Year", ylim = c(0, 300))

# add in horizontal line marking dietary recommendation
abline(h = 280, col = "darkgreen")


```




### Figure 2. Average UK seafood supply (g/capita/week) between 2009 and 2018

```{r Plot average UK seafood supply (g/capita/week) between 2009 and 2018}

# Calculate mean seafood supplied into the UK between 2009 and 2018
# Transpose values and form a data frame 
avg_seafood <- as.data.frame(t(colMeans(df_annualSeafood)))


# Plot bar chart displaying imports (red bar), exports (grey bar), production (orange dot) and dietary recommendation (blue dot) as per Lofstedt et al 2021.

# Up to here...

# Read in NDNS fish consumption data and population cohort data from UK census
```



### Figure 3. UK fish production (capture and aqauculture)

```{r Plot annual UK seafood production (g/capita/week) between 2009 and 2018}
# Plot production (capture and aquaculture data separately)
plot(Aquaprod ~ Year, data = df_annualSeafood, cex.axis = 1.0, cex.lab = 1.5, ylab = "UK seafood production (g/capita/week)", xlab = "Year", ylim = c(0, 100))
lines(CaptureProd ~ Year, data = df_annualSeafood)

# Separate figures
plot(CaptureProd ~ Year, data = df_annualSeafood, cex.axis = 1.0, cex.lab = 1.5, ylab = "UK seafood production (g/capita/week)", xlab = "Year", ylim = c(0, 100))
lines(df_annualSeafood$CaptureProd)

plot(Aquaprod ~ Year, data = df_annualSeafood, cex.axis = 1.0, cex.lab = 1.5, ylab = "UK seafood production (g/capita/week)", xlab = "Year", ylim = c(0, 100), lines(df_annualSeafood$CaptureProd))

```



### Figure 4. Mapping SACN types (oily/lean/shellfish) per commodity

```{r Aggregate oily/lean/shellfish for each commodity}
# Capture Production 
SACN_captProd <- aggregate(df_captProd_NS_data$ValueGramsCapitaWeek, 
                                      by = list(df_captProd_NS_data$SACN,
                                                df_captProd_NS_data$Year), sum)
names(SACN_captProd) <- c("SACNType", "Year", "Summed_CProd")
SACN_captProd <- subset(SACN_captProd, Year < 2019) # up to 2018


# Aquaculture Production 
SACN_aquaProd <- aggregate(df_aquaProd_Eurostat_data_omit$ValueGramsCapitaWeek, 
                                      by = 
                             list(df_aquaProd_Eurostat_data_omit$SACN,
                                  df_aquaProd_Eurostat_data_omit$Year), sum)
names(SACN_aquaProd) <- c("SACNType", "Year", "Summed_AProd")
SACN_aquaProd <- subset(SACN_aquaProd, Year < 2019) # up to 2018


# Imports 
SACN_import <- aggregate(seafoodImports$ValueGramsCapitaWeek, 
                                      by = list(seafoodImports$SACN,
                                                seafoodImports$Year), sum)
names(SACN_import) <- c("SACNType", "Year", "Summed_import")
SACN_import <- subset(SACN_import, Year < 2019) # up to 2018


# Exports 
SACN_export <- aggregate(seafoodExports$ValueGramsCapitaWeek, 
                                      by = list(seafoodExports$SACN,
                                                seafoodExports$Year), sum)
names(SACN_export) <- c("SACNType", "Year", "Summed_export")
SACN_export <- subset(SACN_export, Year < 2019) # up to 2018

```


```{r Merge SACN commodity data bweteen 2009 and 2018 }
# Merge aggregated data
# List all data frames to join together 
SACN_dfs <- list(SACN_captProd, SACN_aquaProd, SACN_import, SACN_export)


# Join data frames by SCANType and Year
df_summedSACNTypes <- join_all(SACN_dfs, by = c("SACNType", "Year")) 

```



### Figure 6. Identify the top 5 produced (capture and aquculture fisheries) seafood species in the UK


```{r Idenitfying the most produced (capture and aquaculture fisheries) seafood species in the UK each year}

# Combine capture and aquaculture data sets to get total UK seafood production
UK_production <- rbind(df_captProd_NS_data, df_aquaProd_Eurostat_data_omit)

capture09 <- subset(UK_production, Year == 2009)
arrange(capture09, desc(ValueGramsCapitaWeek)) # salmon, mackerel, haddock, herring, nephrops

capture10 <- subset(UK_production, Year == 2010)
arrange(capture10, desc(ValueGramsCapitaWeek)) # salmon, mackerel, herring, haddock, scallops

capture11 <- subset(UK_production, Year == 2011)
arrange(capture11, desc(ValueGramsCapitaWeek)) # salmon, mackerel, herring, scallop, haddock

capture12 <- subset(UK_production, Year == 2012)
arrange(capture12, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, nephrops, scallops

capture13 <- subset(UK_production, Year == 2013)
arrange(capture13, desc(ValueGramsCapitaWeek)) # salmon, mackerel, herring, scallops, crabs # change

capture14 <- subset(UK_production, Year == 2014)
arrange(capture14, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, scallops, crabs 

capture15 <- subset(UK_production, Year == 2015)
arrange(capture15, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock scallops, crabs 

capture16 <- subset(UK_production, Year == 2016)
arrange(capture16, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock scallops, cod # change

capture17 <- subset(UK_production, Year == 2017)
arrange(capture17, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock scallops, cod 

capture18 <- subset(UK_production, Year == 2018)
arrange(capture18, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock, cod, blue whiting 

capture19 <- subset(UK_production, Year == 2019) # no aqaucaulture data
arrange(capture19, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock, cod, nephrops whiting 

capture20 <- subset(UK_production, Year == 2020)
arrange(capture18, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock, cod, blue whiting 


# Subset the most caught seafood species as identified from above
top5TotProduction <- subset(UK_production, Species == "Salmon" | Species == "Mackerel" | Species == "Herring" | Species == "Haddock")

# Plot capture production between 2009 and 2020
plot(ValueGramsCapitaWeek ~ Year, data= top5TotProduction, pch= 20, col= c("blue", "green", "red", "orange"), cex.axis = 1.0, cex.lab = 1.5, ylab = "Seafood produced (g/capita/week)", xlab = "Year", ylim = c(0, 20)) # Much overlap thus hard to see the colors

```





### Figure 8. Boxplot of variability in individual seafood commodities supplied to the UK between 2009 and 2018

Calculate seafood supplied in the UK, by species level between 2009 and 2018. 

```{r Merge production and trade data sets together}
# Separate imports and export data
seafoodImports <- subset(df_trade_HMRC_clean_data, Commodity == "Imports")
seafoodExports <- subset(df_trade_HMRC_clean_data, Commodity == "Exports")

# Join together all data sets
# Join capture and aquaculture production together
df_UK_seafoodProduction <- df_allLandingsintoUK_NS_clean_data[,2:4] %>% 
  full_join(df_aquaProd_Eurostat_clean_data[,2:4], by = c("RevisedMCS", "Year"))

# Join production and imports data
df_UK_seafoodProdImp <- df_UK_seafoodProduction %>% 
  full_join(seafoodImports[,2:4], by = c("RevisedMCS", "Year"))

# Join production and trade data
df_UK_seafoodSupply <- df_UK_seafoodProdImp %>% 
  full_join(seafoodExports[,2:4], by = c("RevisedMCS", "Year"))

# Rename columns in new data frame
colnames(df_UK_seafoodSupply) <- c( "RevisedMCS", "Year", "ValueCapture",  "ValueAqua", "ValueImport", "ValueExport")
```



```{r Calculate availability of each species}
# Convert NA to zeros (otherwise availability cannot be calculated)  
df_UK_seafoodSupply[is.na(df_UK_seafoodSupply)] <- 0

# Create new column to calculate availability for each species
df_UK_seafoodSupply$Available <- (df_UK_seafoodSupply$ValueCapture + df_UK_seafoodSupply$ValueAqua + df_UK_seafoodSupply$ValueImport) - df_UK_seafoodSupply$ValueExport

```


```{r Boxplot of variability of individual seafood commodities supplied to the UK}
# Remove Rays Bream from the data set
df_UK_seafoodSupply_new <- df_UK_seafoodSupply[!grepl ("Ray\x92s bream",df_UK_seafoodSupply$RevisedMCS),]

# Plot variability in seafood supplied by species between 2009 and 2018
boxplot(Available ~ RevisedMCS, data = df_UK_seafoodSupply_new, col = "lightgray", 
        ylab = "Seafood supplied to the UK (grams)", xlab = "", las = 3, cex.axis = 1.0)

```




```{r Order species by decending seafood supplied}
# Plot box plot with most to least available seafood supplied

# Reorder a predictor variable (species) by a function applied to the response variable (seafood availability)
# For descending order simply add a minus sign in front of the response variable
bymedian <- with(df_UK_seafoodSupply_new, reorder(RevisedMCS, -Available, median))

# Plot re-order boxplot from most to least available seafood supplied
boxplot(Available ~ bymedian, 
        data = df_UK_seafoodSupply_new, ylab= "Seafood supplied to the UK (grams)", 
        xlab= "", las= 2, col= "lightgrey")

```



Now create new data frames, subsetting species of interest

```{r Boxplot of variability of specific seafood species }

# Subset mackerel
df_UK_mackerelSupplies <- subset(df_UK_seafoodSupply_new, RevisedMCS == "Mackerel")
plot(Available ~ Year, data = df_UK_mackerelSupplies, ylab = "Supplies(g)", xlab= "", las = 1)

# Subset blue whiting
df_UK_bWhitingSupplies <- subset(df_UK_seafoodSupply_new, RevisedMCS == "Blue whiting")
plot(Available ~ Year, data = df_UK_bWhitingSupplies, ylab = "Supplies(g)", xlab= "", las = 1)

# Subset herring whiting
df_UK_herringSupplies <- subset(df_UK_seafoodSupply_new, RevisedMCS == "Herring")
plot(Available ~ Year, data = df_UK_herringSupplies, ylab = "Supplies(g)", xlab= "", las = 1)

```





Plot a boxplot of individual seafood commodities grouped by SACN classification

```{r Boxplot of variability of seafood supplied by SACN}
# Subset data by SACN
df_UK_SupplyCapita_Lean <- subset(df_UK_seafoodSupplyCapita, SACN == "Lean")
df_UK_SupplyCapita_Oily <- subset(df_UK_seafoodSupplyCapita, SACN == "Oily")
df_UK_SupplyCapita_Shellfish <- subset(df_UK_seafoodSupplyCapita, SACN == "Shellfish")

# Plot variability in LEAN seafood supplied by species between 2009 and 2018
boxplot(ValueGramsCapitaWeek ~ SpeciesNEW, data = df_UK_SupplyCapita_Lean, col = "lightgray", 
        ylab = "Seafood supplies", xlab = "", las = 3)

# Plot variability in OILY seafood supplied by species between 2009 and 2018
boxplot(ValueGramsCapitaWeek ~ SpeciesNEW, data = df_UK_SupplyCapita_Oily, col = "lightgray", 
        ylab = "Seafood supplies", xlab = "", las = 3)

# Plot variability in SHELLFISH seafood supplied by species between 2009 and 2018
boxplot(ValueGramsCapitaWeek ~ SpeciesNEW, data = df_UK_SupplyCapita_Shellfish, 
        col = "lightgray", ylab = "Seafood supplies", xlab = "", las = 3)
```


## Figure 9. Mapping nutrient availability 

Here we map the nutrient content of the 5 most produced fish species in the UK between 2009 and 2018. The nutrients mapped included omega-3, calcium, iron, selenium, and zinc. Estimated nutrient data was obtained from PHE. 

```{r Mapping the availabilty of individual nutrients}
# The nutrient content of salmon, mackerel, herring and haddock was mapped between 2009 and 2018.
```


## Not needed 

## Figure 5. Identify the top 5 produced (capture fisheries) seafood species in the UK

```{r Idenitfying the most produced (capture fisheries) seafood species in the UK each year}
capture09 <- subset(df_captProd_NS_data, Year == 2009)
arrange(capture09, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, nephrops, scallops

capture10 <- subset(df_captProd_NS_data, Year == 2010)
arrange(capture10, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, nephrops, scallops

capture11 <- subset(df_captProd_NS_data, Year == 2011)
arrange(capture11, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, nephrops, scallops

capture12 <- subset(df_captProd_NS_data, Year == 2012)
arrange(capture12, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, nephrops, scallops

capture13 <- subset(df_captProd_NS_data, Year == 2013)
arrange(capture13, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, scallops, crabs

capture14 <- subset(df_captProd_NS_data, Year == 2014)
arrange(capture14, desc(ValueGramsCapitaWeek)) # mackerel, haddock, herring, scallops, crabs 

capture15 <- subset(df_captProd_NS_data, Year == 2015)
arrange(capture15, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock scallops, crabs 

capture16 <- subset(df_captProd_NS_data, Year == 2016)
arrange(capture16, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock scallops, cod 

capture17 <- subset(df_captProd_NS_data, Year == 2017)
arrange(capture17, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock scallops, cod 

capture18 <- subset(df_captProd_NS_data, Year == 2018)
arrange(capture18, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock, cod, blue whiting 

capture19 <- subset(df_captProd_NS_data, Year == 2019)
arrange(capture19, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock, cod, nephrops whiting 

capture20 <- subset(df_captProd_NS_data, Year == 2020)
arrange(capture18, desc(ValueGramsCapitaWeek)) # mackerel, herring, haddock, cod, blue whiting 


# Subset the most caught seafood species as identified from above
top5Capture <- subset(df_captProd_NS_data, Species == "Mackerel" | Species == "Herring" | Species == "Haddock")

# Plot capture production between 2009 and 2020
plot(ValueGramsCapitaWeek ~ Year, data= top5Capture, pch= 20, col= c("blue", "green", "red"), cex.axis = 1.0, cex.lab = 1.5, ylab = "Seafood produced (g/capita/week)", xlab = "Year", ylim = c(0, 25))



# Number of replicates dictated by number of rows in the short and narrow data set.
UK_seafood_data$PopSize <- rep(c(df_NS_UK_pop_data$UKPOP), each = nrow(df_UK_landings_08_12_data))


```{r}
# Number of seafood entries differ per year so need to create a pipe
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2020"] <- 67081000
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2019"] <- 66796800
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2018"] <- 66435600
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2017"] <- 66040200
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2016"] <- 65648100
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2015"] <- 65110000
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2014"] <- 64596800
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2013"] <- 64105700
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2012"] <- 63705000
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2011"] <- 63285100
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2010"] <- 62759500
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2009"] <- 62260500

# Make popsize column numerical value
#df_trade_HMRC_data$popSize <- as.numeric(df_trade_HMRC_data$popSize)

order(df_UKseafood_200918$available)
order_seafood <- df_UKseafood_200918 %>% arrange(available)


# Combine data frames by species name and year. Creates short and wide data frame
# Create a list all data frames to join together. Only desired columns (4 to 6) selected.
seafood_dfs <- list(df_captProd_NS_data[,4:6], df_aquaProd_Eurostat_data_omit[,4:6], seafoodImports[,4:6], seafoodExports[,4:6])

# Join data frames by species and year
df_UKseafood_200918 <- join_all(seafood_dfs, by = c("SpeciesNEW", "Year"), match = "all") 

```



## Exploratory figures

```{r Figure 1. UK fish production (capture and aqaucualture data)}
# Plot UK seafood production (merge capture and aquaculture data together) 
UK_production_data <- rbind(df_captureProd_NS_clean_data, df_aquaProd_Eurostat_clean_data)

# Calculate fish produced per week 
UK_production_data$ValueGramsCapitaWeek <- UK_production_data$ValueGramsCapitaDay * 7

# Plot UK fisheries production data between 2009 and 2020
plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_production_data, FUN = sum), xlim = c(2009, 2018), type= "l", lwd= 1.5, ylab = "UK seafood production (g/capita/week)")
```

```{r Figure 2. UK farmed salmon production}
# UK farmed salmon production
# Calculate fish produced per week
farmed_salmon <- subset(df_aquaProd_Eurostat_data, Species == "Atlantic salmon")
farmed_salmon$ValueGramsCapitaWeek <- farmed_salmon$ValueGramsCapitaDay*7

# Plot UK farmed salmon production
plot(ValueGramsCapitaWeek ~ Year, data = farmed_salmon, xlim = c(2009, 2018), type= "l",lwd= 1.5, ylab = "UK salmon production (edible portion g/capita/week)")

```

```{r Figure 3. UK cod capture production}
# UK capture cod production
# Calculate fish produced per week
wild_cod <- subset(df_wildProd_NS_data, Species == "Cod")
wild_cod$ValueGramsCapitaWeek <- wild_cod$ValueGramsCapitaDay*7

# Reorder data set according to Year
wild_cod2 <- wild_cod[order(wild_cod$Year), ]

# Plot UK farmed salmon production
plot(ValueGramsCapitaWeek ~ Year, data = wild_cod2, xlim = c(2009, 2020), type= "l", lwd= 1.5, ylab = "UK cod production (edible portion g/capita/week)")

```

```{r Figure 4. UK seafood trade}
# Subset trade data in to separate commodities 
UK_imports <- subset(df_trade_HMRC_data, Commodity == "Imports")
UK_exports <- subset(df_trade_HMRC_data, Commodity == "Exports")

plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_imports, FUN = sum), xlim = c(2009, 2019), type= "l", lwd= 1.5, ylab = "UK fish imports (g/capita/week)")

plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_exports, FUN = sum), xlim = c(2009, 2019), type= "l", lwd= 1.5, ylab = "UK fish exports (g/capita/week)")


# Plot on same graph
plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_exports, FUN = sum), ylim= c(0,16), xlim = c(2009, 2019), type= "l", lwd= 1.5, ylab = "UK fish traded (g/capita/week)", col= "red") +
  lines(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_imports, FUN = sum), col= "blue") + legend("topright", legend =  c("Import", "Export"), fill = c("blue", "red"))


```

```{r Figure 5. UK fish purchases (houshold and eaten out)}
# Create data frame combining fish purchase data
fish_purchases <- rbind(df_housePurch_DEFRA_data, df_eatenOutPurch_DEFRA_data)

plot(aggregate(ValueGramsCapitaDay ~ Year, data = df_housePurch_DEFRA_data, FUN = sum))
plot(aggregate(ValueGramsCapitaDay ~ Year, data = df_eatenOutPurch_DEFRA_data, FUN = sum))

# Calculate fish purchased per week
fish_purchases$ValueGramsCapitaWeek <- fish_purchases$ValueGramsCapitaDay*7

plot(aggregate(ValueGramsCapitaWeek ~ Year, data = fish_purchases, FUN = sum), xlim = c(2009, 2020), type= "l", lwd= 1.5, ylab = "UK fish purchases (g/capita/week)")

# Interesting with 2020 data- reduction in fish purchases

```



```{r Figure 6. Plot average lean fish capture production (g/capita/day) between 2009 and 2020}

# Subset lean capture fishery production in the UK
prod_lean <- subset(df_wildProd_NS_data, SACN == "Lean", select = c(Year, ValueGramsCapitaDay))

# Subset lean capture fishery production in the UK
prod_oily <- subset(df_wildProd_NS_data, SACN == "Oily", select = c(Year, ValueGramsCapitaDay))

plot(aggregate(ValueGramsCapitaDay ~ Year, data = df_wildProd_NS_data, mean)) # all fish produced 

# Plot lean fish only 
plot(aggregate(ValueGramsCapitaDay ~ Year, data = prod_lean, mean), ylim= c(0, 0.65), col= "red") + points(aggregate(ValueGramsCapitaDay ~ Year, data = prod_oily, mean), col = "blue")


plot(aggregate(ValueGramsCapitaDay ~ Year, data = prod_oily, mean))

```

### END



### Load in cleaned data

### Calculate edible portion of fish (grams) available per capita (g/capita/week)

##### A) by cohort 

```{r UK population by cohort}
# Adults are recommended to consume 2 portion of fish per week (not children) so calculate adult population size 

# Population size > 65. 
pop65_above <- read.csv("WB_pop_65.plus.csv")
str(pop65_above)

# Population size 15 to 64. 
pop15_64 <- read.csv("WB_pop_15.64.csv")
str(pop15_64)

# Population size 0 to 14.
# Children advised to consume half the dietary recommendation -> less than 15. 
pop0_14 <- read.csv("WB_pop_0.14.csv")
str(pop0_14)
```


```{r Average population size for each cohort between 2009 and 2019}
# Calculate average pop size over past 10 years for all age cohorts. New column with mean pop size
pop65_above$meanpop <- rowMeans(subset(pop65_above, select = c(X2007:X2017)), na.rm = TRUE)
pop15_64$meanpop <- rowMeans(subset(pop15_64, select = c(X2007:X2017)), na.rm = TRUE)
pop0_14$meanpop <- rowMeans(subset(pop0_14, select = c(X2007:X2017)), na.rm = TRUE)

# Combine all population cohorts
totalpop <- cbind.data.frame(pop65_above$?..Country.Name, pop65_above$meanpop, pop15_64$meanpop, pop0_14$meanpop)

# Rename dataframe columns 
names(totalpop)<-c("Country", "pop65", "pop15", "pop0")

# Create columns for adults and child pops
totalpop$adultpop<- totalpop$pop65+ totalpop$pop15
totalpop$childpop<- totalpop$pop0
totalpop$totpop<-totalpop$adultpop +(totalpop$childpop*0.5)

```


#####  b) by total population size 

```{r Subset data}
# Extract UK population data between 2009 onwards
df_UK_pop <- subset(df_NS_UK_pop_data, 
                      CDID > 2008, select= c(CDID, UKPOP))

```

```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
df_clean_UK_pop <- df_UK_pop
df_clean_UK_pop$Units <- "UK-total-pop"
df_clean_UK_pop$Data_source <- "National-statistics"
```


```{r Merge summed commodities bweteen 2009 and 2018 }
# Merge aggregated data
df_annualSeafood <- merge(df_allLandingsintoUK_NS_clean_data, df_aquaProd_Eurostat_clean_data, by = Species, Year)

df_annualSeafood <- cbind(df_allLandingsintoUK_NS_clean_data, aquaProd[,2], imports[,2], exports[,2] )

# Rename column in the data frame
names(df_annualSeafood) <- c("Year", "CaptureProd", "Aquaprod", "Imports", "Exports")

```


