---
title: "Laoding_HMRC-data-trial_DELETE-LATER"
author: "B. Scheliga"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Loading Libraries, include=FALSE}
# It is good practice to load all needed libraries in the beginning of the scripted
#library(here)
library(tidyr)
library(tidyverse)
library(vroom) #for loading and transforming data
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data

```

```{r Loading filepath to Raw data}
#Loading file path to project folder
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"

```

```{r Loading HMRC data}
########### HMRC Trade Data

# Filepath to RawData 
filepath <- paste(data_dir,"RawData/csv-files", sep="") 
# reading the HRMC trade data dataset (.csv)
#df_HRMC_2009 <- vroom(file=paste(filepath,"HMRC_UK_trade-2009.csv", sep="/"))
vec_filenames_HMRC <- list.files(filepath, pattern = "HMRC_UK_trade", full.names = TRUE)



print("The following files were loaded:")
i = 1
# Loading the cleaned dataset
for(f in vec_filenames_HMRC){

    temp <- fread(f) # storing the data in a temporary 
    assign(paste("df_HMRC_",i,sep=""),temp) # assigning the df a name based on input dataset
    print(paste(i,". ",sub(paste(".*",filepath,sep=""),"",f),sep="")) # print out which dataset files had been used
    i = i+1
    rm(temp)# removing temp object
}
rm(i)

# Next step is to combine this all into big HMRC data.frame
df_HRMC_2009_to_2019 <- bind_rows(df_HMRC_1, df_HMRC_2, df_HMRC_3, df_HMRC_4, df_HMRC_5, df_HMRC_6)

rm(df_HMRC_1, df_HMRC_2, df_HMRC_3, df_HMRC_4, df_HMRC_5, df_HMRC_6) # removing the unneeded df

```

```{r Check for misisng values in HMRC data}

md.pattern(df_HRMC_2009_to_2019, rotate.names = TRUE)

```




```{r loading EUMOFA data}
############### EUMOFA-file

#The EUMOFA-file with the commodity groups (CN8 code) will help us to easily identify fish for in "Non-Food use" and "Human consumption" in the HMRC-Trade data dataset.

# Filepath to EUMOFA-file with complete CN-8 codes
filepath <- paste(data_dir,"Methods/TradeData", sep="")
# reading the EUMOFA-file
df_EUMOFA_CN8 <- vroom(file=paste(filepath,"EUMOFA_CN-8-values.csv", sep="/"))
## Note: the CN8 codes are related to the respective year, and have change over time.

# We are also loading the Annex 4 from the Metadata 2 - Data management EUFOMA https://www.eumofa.eu/supply-balance-and-other-methodologies
# ANNEX 4 Correlation between Main commercial species(MCS)/Commodity Groups (CG) and CN-8 from 2001 to 2022 Revision 1.2

df_EUMOFA_CN8_MCS_CG <- vroom(file=paste(filepath,"EUMOFA_Annex4.csv", sep="/"))

```
```{r Check for misisng values in HMRC data}

md.pattern(df_EUMOFA_CN8_MCS_CG, rotate.names = TRUE)

md.pattern(df_EUMOFA_CN8, rotate.names = TRUE)

```
We have 25 missing (NA) values in the EUMOFA dataset, 20 in the "Explanation"-column and 5 in the "CN-8 product name"-column. As annoying as NA-values are, in this instance we can ignore them. As these values are irrelevant for us and the next steps, since the EUMOFA Annex 4 dataset has no NA-values and the main commercial species (MCS) and commodity groups (CG) for the respective CN-8 code.  


```{r preparing EUOFA CN8 data.frame}

# need to remove the space from the 'CN-8'-column. But leave it as character, so we don't loose the "0" at the beginning of the CN8 code
# https://stackoverflow.com/questions/20309876/r-how-to-replace-in-a-string

df_EUMOFA_CN8$`CN-8` <- gsub("\\ ","", df_EUMOFA_CN8$`CN-8`)

#df_EUMOFA_CN8_2009 <- df_EUMOFA_CN8 %>% filter(Year %in% "2009" )

print("FYI: In the EUMOFA CN-8 product name-Column are large - symbols, which R does not recognize replaces them with ? in a square")

```

```{r preparing HRMC trade data data.frame}

# Need to separate the CN8 code from the description in the CN8-column of the HMRC data
df_HRMC_2009_to_2019$Subset_aid_CN8 <- gsub(" .*$", "", df_HRMC_2009_to_2019$CN8) # subset string before white space

# Thanks to our psychic abilities, we know that one of the CN8-codes in the HRMC Uk trade is missing its lead 0. And we need to deal with that.  

# Check what will not be joined
df_HMRC_anti <- df_HRMC_2009_to_2019 %>% select('Net Mass (Kg)', 'Flow Type', 'Year','Month', 'Subset_aid_CN8', 'CN8') %>%  anti_join(.,df_EUMOFA_CN8, by = c('Subset_aid_CN8' = 'CN-8'))
#The following CN8 code items were not joined
unique(df_HMRC_anti$CN8)


```

It is item [2] "3074959", were we need to add a lead zero. 

```{r  preparing HRMC trade data data.frame}
# adding the lead 0 to "3074959" in the HRMC UK trade data
df_HRMC_2009_to_2019$Subset_aid_CN8 <- str_replace(df_HRMC_2009_to_2019$Subset_aid_CN8,"3074959","03074959")

# the "Flow Type" is also separate into "EU" and "Non-EU" Imports and Exports
df_HRMC_2009_to_2019$`Flow Type` <- str_replace(df_HRMC_2009_to_2019$`Flow Type`,"Non EU - ","") # needs to be first. Or else line 83 will remove "EU" from "Non EU -"
df_HRMC_2009_to_2019$`Flow Type` <- str_replace(df_HRMC_2009_to_2019$`Flow Type`,"EU - ","")


# Now, we can join the HMRC trade data and the EUMOFA data
df_HMRC_inner <- df_HRMC_2009_to_2019 %>% select('Net Mass (Kg)', 'Flow Type', 'Year','Month', 'Subset_aid_CN8') %>%  inner_join(.,df_EUMOFA_CN8, by = c('Subset_aid_CN8' = 'CN-8', 'Year' ))

```


```{r Calculating annual sum based on CN8 code / Species}
# calculating annual sum, selecting needed columns and converting to Net Mass from kg to 1000 tonnes
df_HRMC.sum <- df_HMRC_inner %>% group_by(CN8 = Subset_aid_CN8,`Product name` =`CN-8 product name`, Year = Year, Commodity =`Flow Type`, CF) %>% summarise(`Net Mass (1000 t)`= sum(`Net Mass (Kg)`)/1000000,`Net Mass (kg)`= sum(`Net Mass (Kg)`))

rm(df_HMRC_inner)

df_HMRC_4DB <-df_HRMC.sum

```

<<<<<<< HEAD

```{r Assigning Main Commercial Species (MCS) and Commodity Group (CG)}

||||||| 5c011dd
<<<<<<< HEAD
```{r Assigning main Commercial Species (MCS) and Commodity Group (CG)}


df_test <- df_HMRC_4DB %>% inner_join(., df_EUMOFA_CN8_MCS_CG, by = c('CN8' = 'CN8 code', 'Year'))



```




```{r Defining FishType & Species from Product Name - exact matches}
# In this chunk, we are only assigning our fish species and types to "exact matches" of the fish species name in the EUMOFA dataset.

||||||| b0909f7
```{r Defining FishType & Species from Product Name}
=======
```{r Defining FishType & Species from Product Name - exact matches}
# In this chunk, we are only assigning our fish species and types to "exact matches" of the fish species name in the EUMOFA dataset.

>>>>>>> f3f01344d0ab28d11b0054b2aee2957b1e0b81a8
# Load FishTYpe and species
# use the grepl () function in a loop to add Fish type and Species 



# Filepath to EUMOFA-file with complete CN-8 codes
filepath <- paste(data_dir,"Methods", sep="")
# reading the EUMOFA-file
df_FishType_Species <- vroom(file=paste(filepath,"Species_and_FishTypes.csv", sep="/"))
## Note: the CN8 codes are related to the respective year, and have change over time.


df_ForLoop <- unique(df_EUMOFA_CN8[,c('CN-8','CN-8 product name',"CF")])
df_ForLoop$Loop_Help <- gsub(r"{\s*\(excl.[^\)]+\)}","",as.character(df_ForLoop$`CN-8 product name`), ignore.case = TRUE) # removing the "excluding"-comment in the EUMOFA Product name to prevent finding our fish types in them and wrongfully assigning them to the CN-8

df_ForLoop$FishType <- NA
df_ForLoop$Species  <- NA
df_ForLoop$Hits <- 0 # to check whether a row had been assign a fish type / species more then once. If the number > 1. It will need to be double checked   

# this loop looks through searches for our fish species in the CN-8 product names and assign the found fish species and the corresponding type. 
# "\\b" in grepl() is to find the exact match of the pattern. As "cod" or other short names could be part of another fish species name
for(i in 1:length(df_ForLoop$`CN-8 product name`)){
  for(f in 1:length(df_FishType_Species$Species)){
    if(grepl(paste("\\b",df_FishType_Species$Species[f],"\\b",sep=""),df_ForLoop$Loop_Help[i],ignore.case = TRUE)){
      df_ForLoop$Species[i] <- df_FishType_Species$Species[f]
      df_ForLoop$FishType[i] <-  df_FishType_Species$FishType[f]
      df_ForLoop$Hits[i] <- df_ForLoop$Hits[i] + 1 # this will count up
      }else{
        if(is.na(df_ForLoop$Species[i])){
          df_ForLoop$Species[i] <- "Not in list"
          df_ForLoop$FishType[i] <-"Not in list"
          }
      }
    }
  }

print(paste(sum(df_ForLoop$Hits>1 & df_ForLoop$CF>=1), "rows need to be double checked. As they had more than 1 fish species assign and are for human consumpation (EUMOFA CF > 0"))

print(paste(sum(grepl("Not in list",df_ForLoop$Species) & df_ForLoop$CF>0), "rows need to be double checked. As they are for human consumpation (EUMOFA CF > 0), but not on our list for fish species"))

df_EUOFA_temp <- df_ForLoop

```

```{r Defining FishType & Species from Product Name - exact matches plurals}
# In this chunk, we are dealing with part of the 392 rows from above. Which are imports and exports products for human consumption, but could not be assigned a fish species through a exact match of the fish species name. This happens when you look for "tuna", but value in the field is "tunas"   

# excluding the wanted data
df_ForLoop <- df_EUOFA_temp %>% filter(grepl("Not in list", Species), CF > 0)
# Resetting some of our helper columns
df_ForLoop$FishType <- NA
df_ForLoop$Species  <- NA
df_ForLoop$Hits <- 0 # to check whether a row had been assign a fish type / species more then once. If the number > 1. It will need to be double checked   

# this loop looks through searches for our fish species in the CN-8 product names and assign the found fish species and the corresponding type. 
# Same loop as in previous chunk, except that we looking for the exact matches of the plurals for the fish species by adding an "s" to the species name
for(i in 1:length(df_ForLoop$`CN-8 product name`)){
  for(f in 1:length(df_FishType_Species$Species)){
    if(grepl(paste("\\b",df_FishType_Species$Species[f],"s\\b",sep=""),df_ForLoop$Loop_Help[i],ignore.case = TRUE)){
      df_ForLoop$Species[i] <- df_FishType_Species$Species[f]
      df_ForLoop$FishType[i] <-  df_FishType_Species$FishType[f]
      df_ForLoop$Hits[i] <- df_ForLoop$Hits[i] + 1 # this will count up
      }else{
        if(is.na(df_ForLoop$Species[i])){
          df_ForLoop$Species[i] <- "Not in list"
          df_ForLoop$FishType[i] <-"Not in list"
          }
      }
    }
  }

print(paste(sum(df_ForLoop$Hits>1 & df_ForLoop$CF>=1), "rows need to be double checked. As they had more than 1 fish species assign and are for human consumpation (EUMOFA CF > 0"))

print(paste(sum(grepl("Not in list",df_ForLoop$Species) & df_ForLoop$CF>0), "rows need to be double checked. As they are for human consumpation (EUMOFA CF > 0), but not on our list for fish species"))
=======

```{r Assigning main Commercial Species (MCS) and Commodity Group (CG)}
>>>>>>> d4f52046c3a9cb49dae443bc679ac6dc66020cf5

df_HMRC_4DB <- df_HMRC_4DB %>% inner_join(., df_EUMOFA_CN8_MCS_CG, by = c('CN8' = 'CN8 code', 'Year'))

<<<<<<< HEAD
# reassign AL classifacation
# do new aggregated sum
||||||| 5c011dd
=======
df_HMRC_4DB <- df_HMRC_4DB %>% inner_join(., df_EUMOFA_CN8_MCS_CG, by = c('CN8' = 'CN8 code', 'Year'))
>>>>>>> d4f52046c3a9cb49dae443bc679ac6dc66020cf5

```


```{r Adding column needed for data base}

# Adding DataSupplier information
df_HMRC_4DB$DataSupplier <- "HMRC"
df_HMRC_4DB$DataSet <- "HMRC Overseas Trade data table - UK Trade Info"
#determining if the Fish is for Human consumption or not based on the CF from the EUMOFA-file
df_HMRC_4DB <- rename(df_HMRC_4DB, Value =`Net Mass (1000 t)`)
<<<<<<< HEAD
df_HMRC_4DB <- rename(df_HMRC_4DB, Species = MCS_descr)
df_HMRC_4DB <- rename(df_HMRC_4DB, SpeciesType = CG)
||||||| 5c011dd
=======
df_HMRC_4DB <- rename(df_HMRC_4DB, FishType = MCS_descr)
df_HMRC_4DB <- rename(df_HMRC_4DB, Species = CG)
>>>>>>> d4f52046c3a9cb49dae443bc679ac6dc66020cf5
df_HMRC_4DB$Units <- "1000 tonnes"
df_HMRC_4DB$TemporalResolution <- "Annual"
df_HMRC_4DB$Flag <- ifelse(df_HMRC_4DB$CF < 0, "EXAMPLES: UC, FiTyAlig", "UC, FiTyAlig, ?????")
df_HMRC_4DB$FlagDescription <- ifelse(df_HMRC_4DB$CF < 0, "EXAMPLES:Units changed, Species aligned ", "Units changed, Species aligned, weight values converted using ?????")


```


<<<<<<< HEAD
```{r Selecting Columns, removing non-food uses and Saving to .csv}
# Selecting Columns
df_HMRC_4DB <- df_HMRC_4DB %>% ungroup %>%  select(DataSupplier, DataSet, Commodity, FishType, Species, Value, Units, Year, TemporalResolution, Flag, FlagDescription)

# Removing Non-food uses im- & exports
df_HMRC_4DB <- df_HMRC_4DB %>%  filter(!Species %in% "Non-food use")

#write.csv()
||||||| 5c011dd
```{r Selecting Columns and Saving to .csv}
df_HMRC_4DB <- df_HMRC_4DB %>% ungroup %>%  select(DataSupplier, DataSet, Commodity, Intention, FishType, Species, Value, Units, Year, TemporalResolution, Flag, FlagDescription)



=======
```{r Selecting Columns and Saving to .csv}
df_HMRC_4DB <- df_HMRC_4DB %>% ungroup %>%  select(DataSupplier, DataSet, Commodity, FishType, Species, Value, Units, Year, TemporalResolution, Flag, FlagDescription)
>>>>>>> d4f52046c3a9cb49dae443bc679ac6dc66020cf5

```

