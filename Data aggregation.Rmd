
---
title: "Data-cleaning. RI-B5-04: UK seafood supply chains"
author: "A.Lofstedt, B.Scheliga"
date: '02/11/2022'
output: html_document
---

```{r setup, include=FALSE}
# sets options for entire document in the first chunk
knitr::opts_chunk$set(echo = TRUE)
```

## Part 1: Cleaning data to map UK seafood supply chains 

This R Markdown document outlines how the data from the various data suppliers used to map UK seafood supply chains was cleaned. 

An overview and summary of the data sources used, and their links, can be found in the supporting excel document. Prior to loading the data into R, the data was initially cleaned. Details describing this process can be found in the supporting excel document. We adivce following this document.    

The justification for the data included in this data set can be found in the supporting excel document.  

## Preparation

```{r Load libraries, include=FALSE}
# Load packages
library(tidyr)
library(dplyr)
library(vroom) # for loading and transforming data
library(tidyverse)
library(reshape2)

```

```{r Load data, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```

```{r Specify the desired file path}
filepath <- paste(data_dir,"RawData/csv-files", sep="") 
# note we are able to change this to another file e.g. saving the output

```

## UK population data (Office of National Statistics)

Download UK population data- need to convert per g/capita data to g/total UK total population.

```{r Load data}
# Read in UK population data 
df_NS_UK_pop_data <- vroom(file=paste(filepath,"NS_UK_population-edit.csv", sep="/"))
```

```{r Subset data}
# Extract UK population data between 2009 onwards
df_UK_pop <- subset(df_NS_UK_pop_data, 
                      CDID > 2008, select= c(CDID, UKPOP))

```

```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
df_clean_UK_pop <- df_UK_pop
df_clean_UK_pop$Units <- "UK-total-pop"
df_clean_UK_pop$Data_source <- "National-statistics"
```


```{r Save cleaned data}
# Change file path to "ProcessedData". Can also use setwd()
filepath <- paste(data_dir,"ProcessedData/csv-files", sep="")
filepath <- paste(data_dir,"ProcessedData", sep="")
write.csv(df_clean_UK_pop, file = paste(filepath,"PopSize_NS.csv", sep=""))

```




## Production

UK fish production data includes capture fisheries and aquaculture production 

### A) Capture fisheries (Office of National Statistics)

```{r Load data (2011 to 2020)}
# i) Landings into the UK by UK vessels: 2011 to 2020 (a)
# extract UK landings data between 2011 and 2020.

# Read in landing data
df_UK_landings_11_20_data <- vroom(file=paste(filepath,"NS_UK_landings-201120-edit.csv", sep="/"), na = c(".."))

# Rename column
names(df_UK_landings_11_20_data)[names(df_UK_landings_11_20_data)=="Species_type"] <- "SpeciesType"

# Provide greater granularity to shellfish species
UK_shellfishLandings_11_20 <- subset(df_UK_landings_11_20_data, SpeciesType == "Shellfish") 

# Default SpeciesType to "mollusc"
UK_shellfishLandings_11_20$SpeciesType <- "Mollusc"

# Allocate crustaceans 
UK_shellfishLandings_11_20$SpeciesType[UK_shellfishLandings_11_20$Species %in% c("Crabs", "Lobsters", "Nephrops", "Shrimps and Prawns")] <- "Crustacean"

# Allocate cephalopods
UK_shellfishLandings_11_20$SpeciesType[UK_shellfishLandings_11_20$Species %in% c("Cuttlefish", "Squid")] <- "Cephalopod"

# Allocate other shellfish
UK_shellfishLandings_11_20$SpeciesType[UK_shellfishLandings_11_20$Species %in% "Other Shellfish"] <- "Other shellfish"

# Combine with data set 
UK_finfishLandings_11_20 <- df_UK_landings_11_20_data[(df_UK_landings_11_20_data$SpeciesType == "Pelagic") | (df_UK_landings_11_20_data$SpeciesType == "Demersal"),]

df_UK_landings_11_20 <- rbind(UK_finfishLandings_11_20, UK_shellfishLandings_11_20)

```

```{r Transform and clean data set (2011 to 2020)}
# Change structure of the data set 
df_UK_landings_201120_long<-melt(df_UK_landings_11_20, id.vars = c("SpeciesType","Species"), variable.name="Year", value.name="Value")

```


```{r Load data (2009 to 2010)}
# ii) Landings into the UK by UK vessels: 2008 to 2012 (b)
# Extract UK landings data between 2009 and 2010. 

# Read in landing data
df_UK_landings_08_12_data <- vroom(file=paste(filepath,"NS_UK_landings-200812-edit.csv", sep="/"),na = c(".."))

# Rename column
names(df_UK_landings_08_12_data)[names(df_UK_landings_08_12_data)=="Species_type"] <- "SpeciesType"

# Provide greater granularity to shellfish species
UK_shellfishLandings_08_12 <- subset(df_UK_landings_08_12_data, SpeciesType == "Shellfish") 

# Default SpeciesType to "mollusc"
UK_shellfishLandings_08_12$SpeciesType <- "Mollusc"

# Allocate crustaceans 
UK_shellfishLandings_08_12$SpeciesType[UK_shellfishLandings_08_12$Species %in% c("Crabs", "Lobsters", "Nephrops", "Shrimps and Prawns")] <- "Crustacean"

# Allocate cephalopods
UK_shellfishLandings_08_12$SpeciesType[UK_shellfishLandings_08_12$Species %in% c("Cuttlefish", "Squid")] <- "Cephalopod"

# Allocate other shellfish
UK_shellfishLandings_08_12$SpeciesType[UK_shellfishLandings_08_12$Species %in% "Other Shellfish"] <- "Other shellfish"

# Combine with data set 
UK_finfishLandings_08_12 <- df_UK_landings_08_12_data[(df_UK_landings_08_12_data$SpeciesType == "Pelagic") | (df_UK_landings_08_12_data$SpeciesType == "Demersal"),]

df_UK_fishLandings_08_12 <- rbind(UK_finfishLandings_08_12, UK_shellfishLandings_08_12)

# Select only years 2009 and 2010
df_UK_landings_09_10 <- subset(df_UK_fishLandings_08_12, 
                           select = c('SpeciesType', 'Species', '2009', '2010'))

```


```{r Transform and clean data set (2009 to 2010)}
# Change structure of the data set 
df_UK_landings_200910_long<-melt(df_UK_landings_09_10, id.vars = c("SpeciesType","Species"), variable.name="Year", value.name="Value")
```

```{r Combine data sets (2009 to 2010 and 2011 to 2020)}
# Combine capture production data sets (2009 to 2010 and 2011 to 2020)
df_clean_UK_landings_09_20 <- rbind(df_UK_landings_201120_long, df_UK_landings_200910_long)
```


```{r Allocate oily or lean}
df_clean_UK_landings_09_20$SACN[df_clean_UK_landings_09_20$SpeciesType == "Crustacean"] <- "Shellfish"
df_clean_UK_landings_09_20$SACN[df_clean_UK_landings_09_20$SpeciesType == "Mollusc"] <- "Shellfish"
df_clean_UK_landings_09_20$SACN[df_clean_UK_landings_09_20$SpeciesType == "Cephalopod"] <- "Shellfish"
df_clean_UK_landings_09_20$SACN[df_clean_UK_landings_09_20$SpeciesType == "Other shellfish"] <- "Shellfish"
df_clean_UK_landings_09_20$SACN[df_clean_UK_landings_09_20$SpeciesType == "Freshwater"] <- "Oily"
df_clean_UK_landings_09_20$SACN[df_clean_UK_landings_09_20$SpeciesType == "Demersal"] <- "Lean"
df_clean_UK_landings_09_20$SACN[df_clean_UK_landings_09_20$SpeciesType == "Pelagic"] <- "Oily"

```



```{r Apply conversion factor to calculate edible portion of the fish}
# Classify species as finfish or shellfish. New column for conversion name
df_clean_UK_landings_09_20$CN[df_clean_UK_landings_09_20$SpeciesType == "Crustacean"] <- "Shellfish"
df_clean_UK_landings_09_20$CN[df_clean_UK_landings_09_20$SpeciesType == "Mollusc"] <- "Shellfish"
df_clean_UK_landings_09_20$CN[df_clean_UK_landings_09_20$SpeciesType == "Cephalopod"] <- "Shellfish"
df_clean_UK_landings_09_20$CN[df_clean_UK_landings_09_20$SpeciesType == "Other shellfish"] <- "Shellfish"
df_clean_UK_landings_09_20$CN[df_clean_UK_landings_09_20$SpeciesType == "Freshwater"] <- "Finfish"
df_clean_UK_landings_09_20$CN[df_clean_UK_landings_09_20$SpeciesType == "Demersal"] <- "Finfish"
df_clean_UK_landings_09_20$CN[df_clean_UK_landings_09_20$SpeciesType == "Pelagic"] <- "Finfish"

# Conversion factors used to convert whole fish weight to edible weight
# State average CF finfish: 0.49; shellfish: 0.28 
df_clean_UK_landings_09_20$CF[df_clean_UK_landings_09_20$CN == "Shellfish"] <- 0.28
df_clean_UK_landings_09_20$CF[df_clean_UK_landings_09_20$CN == "Finfish"] <- 0.49

# Create new column and apply conversion factors values
df_clean_UK_landings_09_20$CFValue<-df_clean_UK_landings_09_20$Value*
  df_clean_UK_landings_09_20$CF

```


```{r Calculate grams available per capita}
# Add in annual UK population data in a separate column. Duplicate population data for each year. Number of replicates dictated by number of rows in the short and narrow data set.
df_clean_UK_landings_09_20$PopSize<- rep(c(df_clean_UK_pop$UKPOP), each = nrow(df_UK_landings_08_12_data))

# Convert raw value from 000's tonnes to grams 
df_clean_UK_landings_09_20$ValueGrams<- (df_clean_UK_landings_09_20$CFValue*1000)*1000000

# Convert grams/year to g/capita/year
df_clean_UK_landings_09_20$ValueGramsCapitaYear<- df_clean_UK_landings_09_20$ValueGrams/df_clean_UK_landings_09_20$PopSize

# Convert grams/year to g/capita/week
df_clean_UK_landings_09_20$ValueGramsCapitaWeek<- df_clean_UK_landings_09_20$ValueGramsCapitaYear/52

# Convert grams/year to g/capita/day
df_clean_UK_landings_09_20$ValueGramsCapitaDay<- df_clean_UK_landings_09_20$ValueGramsCapitaWeek/7

# see apply()?. or before melt, join based on year. then multiply tog
```

```{r Add additional variables to data set}
# Create "cleaned" data frame, defining units and data source 
df_clean_UK_landings_09_20$DataSource <- "National-statistics"
df_clean_UK_landings_09_20$DataSet <- "UK-sea-fisheries-statistics"
df_clean_UK_landings_09_20$Commodity <- "Production"
df_clean_UK_landings_09_20$TempRes <- "Annual"
df_clean_UK_landings_09_20$Flag <- "ConV1, ConV2"
```

```{r Select desired variables for the data set}
dfc_simple_landings_UK <- df_clean_UK_landings_09_20[c("SACN", "SpeciesType", "Species", "Year", "ValueGramsCapitaDay", "DataSource", "DataSet", "Commodity", "Flag")]

```


```{r Save cleaned data}
# Change file path to "ProcessedData". Can also use setwd()
filepath <- paste(data_dir,"ProcessedData/csv-files", sep="")
write.csv(dfc_simple_landings_UK, file = paste(filepath,"ProductionData_NS.csv", sep=""))

#filepath <- paste(data_dir,"ProcessedData", sep="")
#write.csv(dfc_simple_landings_UK, file = paste(filepath,"ProductionData_NS.csv", sep=""))


```


### B) Aquaculture production (CEFAS)

```{r Load data (2013 to 2020)}
# UK aquaculture production 
df_CEFAS_UK_aquaculture_data <- vroom(file=paste(filepath,"CEFAS_UK_aquaculture-201320-edit.csv", sep="/"))

# Rename column
names(df_CEFAS_UK_aquaculture_data)[names(df_CEFAS_UK_aquaculture_data)=="Tonnes"] <- "Units"
```

```{r Transform and clean data set (2013 to 2010)}
# Change structure of the data set 
df_UK_aquaculture_201320_long<-melt(df_CEFAS_UK_aquaculture_data, id.vars = c("Type", "Species", "Units"), variable.name="Year", value.name="Value")

```

```{r Allocating fish species corresonding species type (2013 to 2010)}
# Allocate fish species group type 

```

```{r Load data (2009 to 2012)}
# UK aquaculture production 
df_CEFAS_UK_aqaculture_data <- vroom(file=paste(filepath,".csv", sep="/"))

```


```{r Transform and clean data set (2009 to 2012)}
# Change structure of the data set 
df_UK_aquaculture_201320_long<-melt(df_CEFAS_UK_aqaculture_data, id.vars = c("Type", "Species", "Units"), variable.name="Year", value.name="Value")

```

```{r Allocating fish species corresonding species type (2009 to 2012)}
# Allocate fish species group type 

```


```{r Add units and data source (2013 to 2020)}
# Create "cleaned" data frame, defining units and data source 
df_UK_aquaculture_201320_long$DataSource <- "CEFAS"
df_UK_aquaculture_201320_long$DataSet <- "Aquaculture"
df_UK_aquaculture_201320_long$Commodity <- "Production"
df_UK_aquaculture_201320_long$TempRes <- "Annual"
```

```{r Save cleaned data (CEFAS 2013 to 2020)}

```


### B) Aquaculture production (EUROSTAT)

```{r Load data (2009 to 2020)}
# UK aquaculture production 
df_EUROSTAT_UK_aquaculture_data <- vroom(file=paste(filepath,"EUROSTAT_UK_aquaculture-200920-edited.csv", sep="/"),na = c(":"))
```

```{r Transform and clean data set (2009 to 2020)}
# Change structure of the data set. id.vars states the number of columns not to be stacked
df_EUROSTAT_UKFarmed<-melt(df_EUROSTAT_UK_aquaculture_data, id.vars = c("EUROSTATSpecies", "Species", "SimplifiedSpecies", "SpeciesType"), variable.name="Year", value.name="Value")
```


```{r Allocate oily or lean}
df_EUROSTAT_UKFarmed$SACN[df_EUROSTAT_UKFarmed$SpeciesType == "Crustacean"] <- "Shellfish"
df_EUROSTAT_UKFarmed$SACN[df_EUROSTAT_UKFarmed$SpeciesType == "Mollusc"] <- "Shellfish"
df_EUROSTAT_UKFarmed$SACN[df_EUROSTAT_UKFarmed$SpeciesType == "Cephalopod"] <- "Shellfish"
df_EUROSTAT_UKFarmed$SACN[df_EUROSTAT_UKFarmed$SpeciesType == "Other shellfish"] <- "Shellfish"
df_EUROSTAT_UKFarmed$SACN[df_EUROSTAT_UKFarmed$SpeciesType == "Freshwater"] <- "Oily"
df_EUROSTAT_UKFarmed$SACN[df_EUROSTAT_UKFarmed$SpeciesType == "Demersal"] <- "Lean"
df_EUROSTAT_UKFarmed$SACN[df_EUROSTAT_UKFarmed$SpeciesType == "Pelagic"] <- "Oily"

```


```{r Apply conversion factor to calculate edible portion of the fish}
# Classify species as finfish or shellfish. New column for conversion name
df_EUROSTAT_UKFarmed$CN[df_EUROSTAT_UKFarmed$SpeciesType == "Crustacean"] <- "Shellfish"
df_EUROSTAT_UKFarmed$CN[df_EUROSTAT_UKFarmed$SpeciesType == "Mollusc"] <- "Shellfish"
df_EUROSTAT_UKFarmed$CN[df_EUROSTAT_UKFarmed$SpeciesType == "Freshwater"] <- "Finfish"
df_EUROSTAT_UKFarmed$CN[df_EUROSTAT_UKFarmed$SpeciesType == "Demersal"] <- "Finfish"

# Conversion factors used to convert whole fish weight to edible weight
# State average CF finfish: 0.49; shellfish: 0.28 
df_EUROSTAT_UKFarmed$CF[df_EUROSTAT_UKFarmed$CN == "Shellfish"] <- 0.28
df_EUROSTAT_UKFarmed$CF[df_EUROSTAT_UKFarmed$CN == "Finfish"] <- 0.49

# Create new column and apply conversion factors values
df_EUROSTAT_UKFarmed$CFValue<-df_EUROSTAT_UKFarmed$Value*
  df_EUROSTAT_UKFarmed$CF

```


```{r Calculate grams available per capita}
# Add in annual UK population data in a separate column. Duplicate population data for each year. Number of replicates dictated by number of rows in the short and narrow data set.
df_EUROSTAT_UKFarmed$PopSize<- rep(c(df_clean_UK_pop$UKPOP), each = nrow(df_EUROSTAT_UK_aquaculture_data))

# Convert raw value from 000's tonnes to grams 
df_EUROSTAT_UKFarmed$ValueGrams<- (df_EUROSTAT_UKFarmed$CFValue*1000000)

# Convert grams/year to g/capita/year
df_EUROSTAT_UKFarmed$ValueGramsCapitaYear<- df_EUROSTAT_UKFarmed$ValueGrams/df_EUROSTAT_UKFarmed$PopSize

# Convert grams/year to g/capita/week
df_EUROSTAT_UKFarmed$ValueGramsCapitaWeek<- df_EUROSTAT_UKFarmed$ValueGramsCapitaYear/52

# Convert grams/year to g/capita/day
df_EUROSTAT_UKFarmed$ValueGramsCapitaDay<- df_EUROSTAT_UKFarmed$ValueGramsCapitaWeek/7

```

```{r Add additional variables to data set}
# Create "cleaned" data frame, defining units and data source 
df_EUROSTAT_UKFarmed$DataSource <- "Eurostat"
df_EUROSTAT_UKFarmed$DataSet <- "Aquaculture"
df_EUROSTAT_UKFarmed$Commodity <- "Production"
df_EUROSTAT_UKFarmed$TempRes <- "Annual"
df_EUROSTAT_UKFarmed$Flag <- "Conv2"
```

```{r Select desired variables for the data set}
colnames(df_EUROSTAT_UKFarmed)
df_cleaned_UKFarmed <- df_EUROSTAT_UKFarmed[c("SACN", "SpeciesType", "SimplifiedSpecies", "Year", "ValueGramsCapitaDay", "DataSource", "DataSet", "Commodity", "Flag")]


```


```{r Save cleaned data}
# Change file path to "ProcessedData"
filepath <- paste(data_dir,"ProcessedData", sep="")
write.csv(df_cleaned_UKFarmed, file = paste(filepath,"FarmedData_Eurostat.csv", sep=""))


```


## Trade (HMRC)

```{r Load data from processed data file}
# Some edits are needed to ensure consistency with processed data sets

# Read in UK trade data 
df_trade_HMRC_data <- vroom(file=paste(filepath,"TradeData_HMRC_Preliminary-Cleaned.csv", sep="/"))
str(df_trade_HMRC_data)

```


```{r Calcualte grams available per capita}
# Create new column converting volume from 1000 tonnes to grams
unique(df_trade_HMRC_data$Units)
new_df_trade_HMRC_data$ValueGrams <- (new_df_trade_HMRC_data$Value*1000)*1000000

# Number of seafood entries differ per year so need to create a pipe
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2020"] <- 67081000
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2019"] <- 66796800
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2018"] <- 66435600
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2017"] <- 66040200
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2016"] <- 65648100
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2015"] <- 65110000
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2014"] <- 64596800
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2013"] <- 64105700
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2012"] <- 63705000
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2011"] <- 63285100
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2010"] <- 62759500
df_trade_HMRC_data$popSize[df_trade_HMRC_data$Year %in% "2009"] <- 62260500

# Make popsize column numerical value
df_trade_HMRC_data$popSize <- as.numeric(df_trade_HMRC_data$popSize)

# Calculate grams/capita/year
df_trade_HMRC_data$ValueGramsCapitaYear <- df_trade_HMRC_data$Value/df_trade_HMRC_data$popSize

# Calculate grams/capita/week
df_trade_HMRC_data$ValueGramsCapitaWeek <- df_trade_HMRC_data$ValueGramsCapitaYear/52

# Calculate grams/capita/day
df_trade_HMRC_data$ValueGramsCapitaDay <- df_trade_HMRC_data$ValueGramsCapitaWeek/7

```


```{r Allocate SACN values}
# Create a new column for SACN values
df_trade_HMRC_data$SACN[df_trade_HMRC_data$SpeciesType == "Crustacean"] <- "Shellfish"
df_trade_HMRC_data$SACN[df_trade_HMRC_data$SpeciesType == "Mollusc"] <- "Shellfish"
df_trade_HMRC_data$SACN[df_trade_HMRC_data$SpeciesType == "Cephalopod"] <- "Shellfish"
df_trade_HMRC_data$SACN[df_trade_HMRC_data$SpeciesType == "Other shellfish"] <- "Shellfish"
df_trade_HMRC_data$SACN[df_trade_HMRC_data$SpeciesType == "Freshwater"] <- "Oily"
df_trade_HMRC_data$SACN[df_trade_HMRC_data$SpeciesType == "Demersal"] <- "Lean"
df_trade_HMRC_data$SACN[df_trade_HMRC_data$SpeciesType == "Pelagic"] <- "Oily"
```


```{r Select desired values}
new_df_trade_HMRC_data<- df_trade_HMRC_data[c("SACN", "SpeciesType", "Species","Year", "ValueGramsCapitaDay", "DataSupplier", "DataSet", "Commodity", "Flag")]
```


```{r Save cleaned data}
write.csv(new_df_trade_HMRC_data, file = paste(filepath,"TradeData_HMRC-edits.csv", sep=""))

```


## UK fish consumption (NDNS)

```{r Load data}
# Read in NDNS data
df_NDNS_UK_data <- vroom(file=paste
                      (filepath,"NDNS_UK_consumption-edit.csv", sep="/"))

```

```{r Aggregate cohort information}
# Identify unique age cohorts
unique(df_NDNS_UK_data$`Age category`)

# Create a pipe aggregating sub age cohort totals, irrespective of sex 
NDNS_totals <- df_NDNS_UK_data[df_NDNS_UK_data$`Age category` %in% c("Children 1.5-3 years", "Children 4-10 years", "Children 11-18 years", "Adults 19-64 years", "Adults 65 years and over"), ]

# Sum all consumption data for all years 
df_NDNSSummed <- as.data.frame(apply(NDNS_totals[3:7], 2, sum))

df_NDNSSummed <- as.data.frame(apply(NDNS_totals[c("(2008/09 - 2009/10)", 
"(2010/11 - 2011/12)", "(2012/13 - 2013/14)", "(2014/15-2015/16)",  
"(2016/17-2018/19)")], 2, sum))

df_NDNSSummed <- as.data.frame(colSums(NDNS_totals[c("(2008/09 - 2009/10)", 
"(2010/11 - 2011/12)", "(2012/13 - 2013/14)", "(2014/15-2015/16)",  
"(2016/17-2018/19)")]))

# Rename first column 
df_NDNSSummed<- colnames("Year", "Value")

####

NDNSYears <- c("(2008/09 - 2009/10)", 
"(2010/11 - 2011/12)", "(2012/13 - 2013/14)", "(2014/15-2015/16)",  
"(2016/17-2018/19)")

SumnedNDNS <- as.data.frame(colSums(NDNS_totals[c("(2008/09 - 2009/10)", 
"(2010/11 - 2011/12)", "(2012/13 - 2013/14)", "(2014/15-2015/16)",  
"(2016/17-2018/19)")]))

df_NDNSSummed<- data.frame(NDNS_colnams, SumnedNDNS)



```

```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
df_clean_NDNS$Units <- "g/capita/day"
df_clean_NDNS$DataSource <- "NDNS"
df_clean_NDNS$DataSet <- "NDNS"
df_clean_NDNS$Commodity <- "Consumption"
df_clean_NDNS$TempRes <- "Biennial"

# SpeciesType, SACN and Species unknown
df_clean_NDNS$SpeciesType <- "Unknown"
df_clean_NDNS$SACN <- "Unknown"
df_clean_NDNS$Species <- "Unknown"
```


```{r Select desired variables for the data set}
dfc_UK_NDNS <- df_clean_NDNS[c("SACN", "SpeciesType", "Year", "ValueGramsCapitaDay", "DataSource", "DataSet", "Commodity", "flag")]

```


```{r Save cleaned data}

```


## UK fish purchasing data (DEFRA and Kantar)

### A) DEFRA family food data sets

#### i) DEFRA UK purchases (both household and eating out)

```{r Load data 2016 to 2020} 
# Error in raw data in 2015 so data from 2016 onwards used

# read DEFRA purchasing (household and eating out) data (.csv)
df_DEFRA_purchase_201620_data <- vroom(file=paste(filepath,"DEFRA_UK_purchases-201620.csv", sep="/"))

# State full calendar year date
df_DEFRA_purchase_201620_data$Year[df_DEFRA_purchase_201620_data$Year==15] <- 2015
df_DEFRA_purchase_201620_data$Year[df_DEFRA_purchase_201620_data$Year==16] <- 2016
df_DEFRA_purchase_201620_data$Year[df_DEFRA_purchase_201620_data$Year==17] <- 2017
df_DEFRA_purchase_201620_data$Year[df_DEFRA_purchase_201620_data$Year==18] <- 2018
df_DEFRA_purchase_201620_data$Year[df_DEFRA_purchase_201620_data$Year==19] <- 2019
df_DEFRA_purchase_201620_data$Year[df_DEFRA_purchase_201620_data$Year==20] <- 2020
unique(df_DEFRA_purchase_201620_data$Year)

# Separate purchasing data for household and eating out purposes based on code. Create a pipe aggregating fish products consumed within the household and eaten out
df_DEFRA_eaten_out_201620 <- df_DEFRA_purchase_201620_data[df_DEFRA_purchase_201620_data$codecat %in% c( "eo120101", "eo120102", "eo120201", "eo120202", "eo1203", "eo1204", "eo1205", "eo120601", "eo120602", "eo120603"), ]

df_DEFRA_household_201620 <- df_DEFRA_purchase_201620_data[df_DEFRA_purchase_201620_data$codecat %in% c( "10201", "10202", "10601", "10602", "10701", "10702", "10801", "11401", "11702", "11702", "118", "119", "120", "121", "12304", "12305"), ]

```


### i) Household purchases (DEFRA 2016 to 2020)

```{r Allocate SpeciesType to food groups}
# Identify unique major food groups descriptions 
unique(df_DEFRA_household_201620$codeDESCRIPTION)

# Major food codes according to FAO groupings
df_DEFRA_household_201620$SpeciesType <- "Unknown"
unique(df_DEFRA_household_201620$SpeciesType)

df_DEFRA_household_201620$SpeciesType[df_DEFRA_household_201620$codecat %in% c("10201", "10202", "11401")] <- "Demersal"
df_DEFRA_household_201620$SpeciesType[df_DEFRA_household_201620$codecat %in% c("11702", "11703")] <- "Shellfish"
df_DEFRA_household_201620$SpeciesType[df_DEFRA_household_201620$codecat %in% c("10601", "10602", "10701", "10702", "10801", "119")]<-"Pelagic"

```

```{r Allocate SACN i.e. lean or oily}
df_DEFRA_household_201620$SACN[df_DEFRA_household_201620$SpeciesType %in% 
                                 c("Pelagic")] <- "Oily"
df_DEFRA_household_201620$SACN[df_DEFRA_household_201620$SpeciesType %in%
                                 c("Demersal")]<-"Lean"
df_DEFRA_household_201620$SACN[df_DEFRA_household_201620$SpeciesType %in%
                                 c("Unknown")]<-"Unknown"
df_DEFRA_household_201620$SACN[df_DEFRA_household_201620$SpeciesType %in%
                                 c("Shellfish")]<-"Shellfish"

```


```{r Calculate grams available per capita}
# Rename "estimate column"
names(df_DEFRA_household_201620)[names(df_DEFRA_household_201620)=="estimate"] <- "ValueGramsCapitaWeek"

# Convert grams/capita/week to grams/capita/day
df_DEFRA_household_201620$ValueGramsCapitaDay <-  df_DEFRA_household_201620$ValueGramsCapitaWeek/7

```

```{r Select desired variables from data set}
# Rename columns
names(df_DEFRA_household_201620)[names(df_DEFRA_household_201620)=="codeDESCRIPTION"] <- "Species"

# Create new data frame with desired variables
dfc_DEFRA_household_201520 <- df_DEFRA_household_201620[c("SACN", "SpeciesType", "Species", "Year", "ValueGramsCapitaDay")]

# Check data
plot(aggregate(ValueGramsCapitaDay ~ Year, data = df_DEFRA_household_201620, FUN = sum))
plot(aggregate(ValueGramsCapitaDay ~ SpeciesType, data = df_DEFRA_household_201620, FUN = sum))
```


### ii) Eating out (DEFRA 2016 to 2020)

```{r Allocate SpeciesType to food groups}
# Identify unique major food groups descriptions 
unique(df_DEFRA_eaten_out_201620$codeDESCRIPTION)

# Major food codes according to FAO groupings
df_DEFRA_eaten_out_201620$SpeciesType <- "Unknown"
unique(df_DEFRA_eaten_out_201620$codecat)

df_DEFRA_eaten_out_201620$SpeciesType[df_DEFRA_eaten_out_201620$codecat %in% c("eo120102", "eo120101")] <- "Demersal"
df_DEFRA_eaten_out_201620$SpeciesType[df_DEFRA_eaten_out_201620$codecat %in% c("eo1203")] <- "Shellfish"
df_DEFRA_eaten_out_201620$SpeciesType[df_DEFRA_eaten_out_201620$codecat %in% c("eo1204", "eo120202")] <- "Pelagic"

### Trout, tuna and salmon aggregated together 

```


```{r Allocate SACN i.e. lean or oily}
df_DEFRA_eaten_out_201620$SACN[df_DEFRA_eaten_out_201620$SpeciesType %in% c("Pelagic")] <- "Oily"
df_DEFRA_eaten_out_201620$SACN[df_DEFRA_eaten_out_201620$SpeciesType %in% c("Demersal")] <- "Lean"
df_DEFRA_eaten_out_201620$SACN[df_DEFRA_eaten_out_201620$SpeciesType %in% c("Unknown")] <- "Unknown"
df_DEFRA_eaten_out_201620$SACN[df_DEFRA_eaten_out_201620$SpeciesType %in% c("Shellfish")] <- "Shellfish"

# Note
df_DEFRA_eaten_out_201620$SACN[df_DEFRA_eaten_out_201620$codecat %in% c("eo120201")] <- "Oily" # note: Trout, tuna and salmon aggregated together thus can allocate via SpeciesType

```


```{r Calculate grams available per capita}

names(df_DEFRA_eaten_out_201620)[names(df_DEFRA_eaten_out_201620)=="estimate"] <- "ValueGramsCapitaWeek"

# Calculate grams/capita/week to grams/capita/day
df_DEFRA_eaten_out_201620$ValueGramsCapitaDay <-  df_DEFRA_eaten_out_201620$ValueGramsCapitaWeek/7

```


```{r Select desired variables from data set}
# Rename columns
colnames(df_DEFRA_eaten_out_201620)
names(df_DEFRA_eaten_out_201620)[names(df_DEFRA_eaten_out_201620)=="codeDESCRIPTION"] <- "Species"

# Create new data frame with desired variables
dfc_DEFRA_eatenOut_201620 <- df_DEFRA_eaten_out_201620[c("SACN", "SpeciesType", "Species", "Year", "ValueGramsCapitaDay")]

```


#### iii) Household purchases (DEFRA 2009 to 2015)

```{r Load data (2009 to 2015)}
# read DEFRA household data set (.csv)
df_DEFRA_household_data <- vroom(file=paste(filepath,"DEFRA_UK_household-200915-edited.csv", sep="/"))

# Select only years 2009 to 2015
df_DEFRA_household_200914 <- subset(df_DEFRA_household_data, 
                           select = c("Code", "Food Category", "Food Group",
                                      "Major Food Code", "Minor Food Code",
                                      "Units", "2009", "2010", "2011",
                                      "2012", "2013", "2014", "2015"))

```


```{r Delete later}
# check data
df_DEFRA_household_2015 <- subset(df_DEFRA_household_data, 
                           select = c("Code", "Food Category", "Food Group",
                                      "Major Food Code", "Minor Food Code",
                                      "Units", "2009", "2010", "2011",
                                      "2012", "2013", "2014", "2015"))




# Change structure of the data set 
df_DEFRA_household_20015_long<-melt(df_DEFRA_household_2015, id.vars = c("Code", "Food Category", "Food Group", "Major Food Code", "Minor Food Code","Units", "Minor Food Code", "Units"), variable.name="Year", value.name="Value")

plot(aggregate(Value ~ Year, data = df_DEFRA_household_20015_long, FUN= sum))

```



```{r Allocate SpeciesType to food groups}
# Identify unique major food groups
unique(df_DEFRA_household_200915$`Major Food Code`)

# Major food codes according to FAO groupings
df_DEFRA_household_200915$SpeciesType <- "Unknown"
df_DEFRA_household_200915$SpeciesType[df_DEFRA_household_200915$`Major Food Code` == "White fish, fresh, chilled or frozen"] <- "Demersal"
df_DEFRA_household_200915$SpeciesType[df_DEFRA_household_200915$`Major Food Code` == "White fish, dried, salted or smoked"] <- "Demersal"
df_DEFRA_household_200915$SpeciesType[df_DEFRA_household_200915$`Major Food Code` == "Shellfish"] <- "Shellfish"
df_DEFRA_household_200915$SpeciesType[df_DEFRA_household_200915$`Major Food Code` == "Herrings and other blue fish, fresh, chilled or frozen"] <-"Pelagic"
df_DEFRA_household_200915$SpeciesType[df_DEFRA_household_200915$`Major Food Code` == "Salmon, fresh, chilled or frozen"] <- "Pelagic"
df_DEFRA_household_200915$SpeciesType[df_DEFRA_household_200915$`Major Food Code` == "Blue fish, dried or salted or smoked"] <- "Pelagic"
df_DEFRA_household_200915$SpeciesType[df_DEFRA_household_200915$`Major Food Code` == "Salmon, tinned"] <- "Pelagic"

# Remove rows where sum is provided 
df_DEFRA_household_200915_clean<-df_DEFRA_household_200915[!grepl("Sum", 
                                         df_DEFRA_household_200915$`Minor Food Code`),]

```


```{r Allocate SACN i.e. lean or oily}
df_DEFRA_household_200915_clean$SACN[df_DEFRA_household_200915_clean$SpeciesType %in% c("Pelagic")] <- "Oily"
df_DEFRA_household_200915_clean$SACN[df_DEFRA_household_200915_clean$SpeciesType %in% c("Demersal")]<-"Lean"
df_DEFRA_household_200915_clean$SACN[df_DEFRA_household_200915_clean$SpeciesType %in% c("Unknown")]<-"Unknown"
df_DEFRA_household_200915_clean$SACN[df_DEFRA_household_200915_clean$SpeciesType %in% c("Shellfish")]<-"Shellfish"

```


```{r Transform and clean data set}
# Subset data frame to include variables we want before changing structure
df_DEFRA_household_200915_main<-subset(df_DEFRA_household_200915_clean, select= c("Minor Food Code", "Units", "2009", "2010", "2011", "2012", "2013", "2014","2015", "SpeciesType", "SACN"))

# Change structure of the data set 
df_DEFRA_household_200915_long<-melt(df_DEFRA_household_200915_main, id.vars = c("Minor Food Code", "Units", "SpeciesType", "SACN"), variable.name="Year", value.name="Value")

# Rename columns for consistency 
colnames(df_DEFRA_household_200915_long)
names(df_DEFRA_household_200915_long)[names(df_DEFRA_household_200915_long)=="Minor Food Code"] <- "Species"

```


```{r Calculate grams available per capita}
names(df_DEFRA_household_200915_long)[names(df_DEFRA_household_200915_long)=="Value"] <- "ValueGramsCapitaWeek"

df_DEFRA_household_200915_long$ValueGramsCapitaDay <- df_DEFRA_household_200915_long$ValueGramsCapitaWeek/7

```


```{r Select desired variables from data set}
# Rename columns
colnames(df_DEFRA_household_200915_long)
names(df_DEFRA_household_200915_long)[names(df_DEFRA_household_200915_long)=="codeDESCRIPTION"] <- "Species"

# Create new data frame with desired variables
dfc_DEFRA_household_200915 <- df_DEFRA_household_200915_long[c("SACN", "SpeciesType", "Species", "Year", "ValueGramsCapitaDay")]

```


```{r Combine DEFRA household data sets (2009 to 2015 and 2016 to 2020)}
# Combine household data (2009 to 2015 and 2016 to 2020)
colnames(dfc_DEFRA_household_200915)
str(dfc_DEFRA_household_200915)
unique(dfc_DEFRA_household_200915$Year)

colnames(dfc_DEFRA_household_201620)
str(dfc_DEFRA_household_201620)
unique(dfc_DEFRA_household_201620$Year)


# Ensure "Year" column is as a factor value
dfc_DEFRA_household_200915$Year<-as.factor(dfc_DEFRA_household_200915$Year)
dfc_DEFRA_household_201620$Year<-as.factor(dfc_DEFRA_household_201620$Year)

# Row bind data frames (2009 to 2020)
dfc_DEFRA_household_200920 <- rbind(dfc_DEFRA_household_200915, dfc_DEFRA_household_201620)

str(dfc_DEFRA_household_200920)
unique(dfc_DEFRA_household_200920$Year)

```


```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
dfc_DEFRA_household_200920$DataSource <- "DEFRA"
dfc_DEFRA_household_200920$DataSet <- "household"
dfc_DEFRA_household_200920$Commodity <- "Purchase"
dfc_DEFRA_household_200920$Flag <- "ConV2"

```


```{r Save cleaned data}
# Change file path to "ProcessedData"
filepath <- paste(data_dir,"ProcessedData", sep="")
write.csv(dfc_DEFRA_household_200920, file = paste(filepath,"HouseholdPurchases_DEFRA.csv", sep=""))


```


#### ii) Eating out (DEFRA 2009 to 2015)

```{r Load data (2009 to 2015)}
# read DEFRA eaten out data set
df_DEFRA_eaten_out_data <- vroom(file=paste(filepath,"DEFRA_UK_eatenOut-200915-edited.csv", sep="/"))

# Select only years 2009 to 2015
df_DEFRA_EO_200915 <- subset(df_DEFRA_eaten_out_data, 
                           select = c("Code", "EO Food Group", 
                                      "EO Major code", "EO Minor code",
                                      "Units", "2009", "2010", "2011",
                                      "2012", "2013","2014", "2015"))
```


```{r Allocate SpeciesType to food group}
# Identify unique major food groups
unique(df_DEFRA_EO_200915$`EO Major code`)

# Major food codes according to FAO groupings.
df_DEFRA_EO_200915$SpeciesType <- "Unknown"
df_DEFRA_EO_200915$SpeciesType[df_DEFRA_EO_200915$`EO Major code` == "White fish"] <- "Demersal"
df_DEFRA_EO_200915$SpeciesType[df_DEFRA_EO_200915$`EO Major code` == "Shellfish - without sauce or dressing (e.g. prawns, shrimps, oysters, crab)"] <- "Shellfish"
df_DEFRA_EO_200915$SpeciesType[df_DEFRA_EO_200915$`EO Major code` == "Fatty fish"] <- "Pelagic"
df_DEFRA_EO_200915$SpeciesType[df_DEFRA_EO_200915$`EO Major code` == "Kippers and other smoked fish (e.g. smoked salmon)"] <- "Pelagic"

# Remove rows where sum is provided 
df_DEFRA_EO_200915_clean<-df_DEFRA_EO_200915[!grepl("Sum", 
                                         df_DEFRA_EO_200915$`EO Minor code`),]

```


```{r Allocate SACN i.e. lean or oily}
df_DEFRA_EO_200915_clean$SACN[df_DEFRA_EO_200915_clean$SpeciesType %in% c("Pelagic")] <- "Oily"
df_DEFRA_EO_200915_clean$SACN[df_DEFRA_EO_200915_clean$SpeciesType %in% c("Demersal")]<-"Lean"
df_DEFRA_EO_200915_clean$SACN[df_DEFRA_EO_200915_clean$SpeciesType %in% c("Unknown")]<-"Unknown"
df_DEFRA_EO_200915_clean$SACN[df_DEFRA_EO_200915_clean$SpeciesType %in% c("Shellfish")]<-"Shellfish"

```


```{r Transform and clean data set}
# Subset data frame to include variables we want 
df_DEFRA_EO_200915_main<-subset(df_DEFRA_EO_200915_clean, select= c("EO Minor code", "Units", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "SpeciesType", "SACN"))

# Change structure of the data set 
df_DEFRA_eatenOut_200915_long<-melt(df_DEFRA_EO_200915_main, id.vars = c("EO Minor code", "Units", "SpeciesType", "SACN"), variable.name="Year", value.name="Value")
```


```{r Calculate grams available per capita}
# Change column variable name to include units 
names(df_DEFRA_eatenOut_200915_long)[names(df_DEFRA_eatenOut_200915_long)=="Value"] <- "ValueGramsCapitaWeek"

# Calculate grams available per capita per day
df_DEFRA_eatenOut_200915_long$ValueGramsCapitaDay <- df_DEFRA_eatenOut_200915_long$ValueGramsCapitaWeek/7

```


```{r Select desired variables from data set}
# Rename columns
colnames(df_DEFRA_eatenOut_200915_long)
names(df_DEFRA_eatenOut_200915_long)[names(df_DEFRA_eatenOut_200915_long)=="EO Minor code"] <- "Species"

# Create new data frame with desired variables
dfc_DEFRA_eatenOut_200915 <- df_DEFRA_eatenOut_200915_long[c("SACN", "SpeciesType", "Species", "Year", "ValueGramsCapitaDay")]

```


```{r Combine DEFRA eating out data (2009 to 2015 and 2015 to 2020)}
# Convert "Year" to a factor value
str(dfc_DEFRA_eatenOut_201520)
str(dfc_DEFRA_eatenOut_201520)

dfc_DEFRA_eatenOut_201520$Year <- as.factor(dfc_DEFRA_eatenOut_201520$Year)

# Combine DEFRA eating out data between 2009 to 2015 and 2015 to 2020
dfc_DEFRA_eatenOut_200920 <- rbind(dfc_DEFRA_eatenOut_200915, dfc_DEFRA_eatenOut_201520)

```


```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
dfc_DEFRA_eatenOut_200920$DataSource <- "DEFRA"
dfc_DEFRA_eatenOut_200920$DataSet <- "eatenOut"
dfc_DEFRA_eatenOut_200920$Commodity <- "Purchase"
dfc_DEFRA_eatenOut_200920$Flag <- "ConV1, ConV3"

```


```{r Save cleaned data}
write.csv(dfc_DEFRA_eatenOut_200920, file = paste(filepath,"EatenOutPurchases_DEFRA.csv", sep=""))

```

#### END

######## Code not needed 

### B) Aquaculture production (Marine Scotland and DEFRA)

```{r Load data (Scotland: Marine Scotland Science)}
# a) Aquaculture production in Scotland
# i) salmon, ii) rainbow trout, iii) shellfish
df_MSS_salmon_data <- vroom(file=paste(filepath,"MSS_Scotland_aquacultureSalmon.csv", sep="/"), na = c(".."))

df_MSS_rainbowTrout_data <- vroom(file=paste(filepath,"MSS_Scotland_aquacultureRainbowTrout.csv", sep="/"), na = c(".."))

df_MSS_shellfish_data <- vroom(file=paste(filepath,"MSS_Scotland_aquacultureShellfish.csv", sep="/"), na = c(".."))

```

```{r Subset data (Scotland: Marine Scotland Science)}
# Determine products are for human consumption 
df_MSS_shellfish_HC <- subset(df_MSS_shellfish_data, Production == "For the table")

# Subset data between 2009 and 2021 
df_MSS_salmon <- subset(df_MSS_salmon_data, Year > 2008, 
                        select= c(Year, Tonnes)) 

df_MSS_rainbowTrout <- subset(df_MSS_rainbowTrout_data, Year > 2008, 
                        select= c("Year", "Total Tonnes"))

df_MSS_shellfish <- subset(df_MSS_shellfish_HC, Year > 2008)

# State species, unit and data source
df_MSS_salmon$Units <- "tonnes"
df_MSS_salmon$Species <- "Salmon"
df_MSS_salmon$SpeciesType <- "Diadromous"

df_MSS_rainbowTrout$Units <- "tonnes"
df_MSS_rainbowTrout$Species <- "RainbowTrout"
df_MSS_rainbowTrout$SpeciesType <- "Freshwater"

df_MSS_shellfish$Units <- "Varied"
df_MSS_shellfish$Species <- "Varied"
df_MSS_rainbowTrout$SpeciesType <- "Shellfish"

```

```{r Combine Scottish aqacualture production data}

#df_MMS_production<- merge(df_MSS_salmon, df_MSS_rainbowTrout)

```


```{r Add units and data source (Scotland: Marine Scotland Science)}
# Create "cleaned" data frame, defining units and data source 

#df_clean_UK_landings_09_20$Units <- "tonnes or numbers"
df_MMS_production$DataSource <- "Marine_Scotland"
df_MMS_production$DataSet <- "Scottish-aquaculture"
df_MMS_production$Commodity <- "Production"
df_MMS_production$TempRes <- "Annual"
```