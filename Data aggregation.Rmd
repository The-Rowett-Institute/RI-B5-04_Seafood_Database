
---
title: "Data cleaning. RI-B5-04: UK seafood supply chains"
author: "A.Lofstedt, B.Scheliga"
date: '19/10/2022'
output: html_document
---

```{r setup, include=FALSE}
# sets options for entire document in the first chunk
knitr::opts_chunk$set(echo = TRUE)
```

## Part 1: Cleaning data to map UK seafood supply chains 

This R Markdown document (part 1) outlines how the data complied in the final spreadsheet mapping UK seafood supply chains was cleaned. 

The justification for the data included in this data set can be found in the supporting excel document.  

## Preparation

```{r Load libraries, include=FALSE}
# Load packages
library(tidyr)
library(dplyr)
library(vroom) # for loading and transforming data
library(tidyverse)
library(reshape2)

```

```{r Load data, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```

```{r Specify the desired file path}
filepath <- paste(data_dir,"RawData/csv-files", sep="") 
# note we are able to change this to another file e.g. saving the output

```

## UK population data (Office of National Statistics)

Download UK population data- need to convert per g/capita data to g/total UK total population.

```{r Load data}
# Read in UK population data 
df_NS_UK_pop_data <- vroom(file=paste(filepath,"NS_UK_population-edit.csv", sep="/"))
```

```{r Subset data}
# Extract UK population data between 2009 onwards
df_UK_pop <- subset(df_NS_UK_pop_data, 
                      CDID > 2008, select= c(CDID, UKPOP))

```

```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
df_clean_UK_pop <- df_UK_pop
df_clean_UK_pop$Units <- "UK-total-pop"
df_clean_UK_pop$Data_source <- "National-statistics"
```

```{r Save cleaned data}
#filepath <- paste(data_dir,"ProcessedData/csv-files", sep="") 
#NS_UK_capture_cleaned <- write.csv(df_clean_UK_landings_09_20,file = paste(filepath,"namefile.csv", sep=""))
```


## Production

UK fish production data includes capture fisheries and aquaculture production 

### A) Capture fisheries (Office of National Statistics)

```{r Load data (2011 to 2020)}
# i) Landings into the UK by UK vessels: 2011 to 2020 (a)
# extract UK landings data between 2011 and 2020.

# Read in landing data
df_UK_landings_11_20_data <- vroom(file=paste(filepath,"NS_UK_landings-201120-edit.csv", sep="/"), na = c(".."))

# Rename column
names(df_UK_landings_11_20_data)[names(df_UK_landings_11_20_data)=="Species_type"] <- "SpeciesType"

```

```{r Transform and clean dataset (2011 to 2020)}
# Change structure of the dataset 
df_UK_landings_201120_long<-melt(df_UK_landings_11_20_data, id.vars = c("SpeciesType","Species"), variable.name="Year", value.name="Value")

```


```{r Load data (2009 to 2010)}
# ii) Landings into the UK by UK vessels: 2008 to 2012 (b)
# Extract UK landings data between 2009 and 2010. 

# Read in landing data
df_UK_landings_08_12_data <- vroom(file=paste(filepath,"NS_UK_landings-200812-edit.csv", sep="/"),na = c(".."))

# Rename column
names(df_UK_landings_08_12_data)[names(df_UK_landings_08_12_data)=="Species_type"] <- "SpeciesType"

# Select only years 2009 and 2010
df_UK_landings_09_10 <- subset(df_UK_landings_08_12_data, 
                           select = c('SpeciesType', 'Species', '2009', '2010'))

```


```{r Transform and clean dataset (2009 to 2010)}
# Change structure of the dataset 
df_UK_landings_200910_long<-melt(df_UK_landings_09_10, id.vars = c("SpeciesType","Species"), variable.name="Year", value.name="Value")
```

```{r Combine datasets (2009 to 2010 and 2011 to 2020)}
# Combine capture production data sets (2009 to 2010 and 2011 to 2020)
df_clean_UK_landings_09_20 <- rbind(df_UK_landings_201120_long, df_UK_landings_200910_long)
```


```{r Apply conversion factor to calculate edible portion of the fish}
# Conversion factors used to convert whole fish weight to edible weight

# State average CF finfish: 0.49; shellfish: 0.28 
df_clean_UK_landings_09_20$CF[df_clean_UK_landings_09_20$SpeciesType == "Shellfish"] <- 0.28
df_clean_UK_landings_09_20$CF[df_clean_UK_landings_09_20$SpeciesType == "Demersal"] <- 0.49
df_clean_UK_landings_09_20$CF[df_clean_UK_landings_09_20$SpeciesType == "Pelagic"] <- 0.49 

# Create new column and apply conversion factors values
df_clean_UK_landings_09_20$CFValue<-df_clean_UK_landings_09_20$Value*
  df_clean_UK_landings_09_20$CF

```


```{r Calculate grams available per capita}
# Add in annual UK population data in a separate column. Duplicate population data for each year. Number of replicates dictated by number of rows in the short and narrow data set.
df_clean_UK_landings_09_20$PopSize<- rep(c(df_clean_UK_pop$UKPOP), each = nrow(df_UK_landings_11_20_data))

# Convert raw value from 000's tonnes to grams 
df_clean_UK_landings_09_20$ValueGrams<- (df_clean_UK_landings_09_20$CFValue*1000)*1000000

# Convert grams/year to g/capita/year
df_clean_UK_landings_09_20$ValueGramsPerCapita<- df_clean_UK_landings_09_20$ValueGrams/df_clean_UK_landings_09_20$PopSize

# see apply()?. or before melt, join based on year. then multiply tog
```

```{r Add additional variables to data set}
# Create "cleaned" data frame, defining units and data source 
df_clean_UK_landings_09_20$ValueUnits <- "000-tonnes"
df_clean_UK_landings_09_20$DataSource <- "National-statistics"
df_clean_UK_landings_09_20$Dataset <- "UK-sea-fisheries-statistics"
df_clean_UK_landings_09_20$Commodity <- "Production"
df_clean_UK_landings_09_20$TempRes <- "Annual"
```


```{r Save cleaned data}
# Change file path to "ProcessedData"
#filepath <- paste(data_dir,"ProcessedData/csv-files", sep="") 
#NS_UK_capture_cleaned <- write.csv(df_clean_UK_landings_09_20,file = paste(filepath,"namefile.csv", sep=""))

# can also use setwd()

```

### B) Aquaculture production (CEFAS)

```{r Load data (2013 to 2020)}
# UK aquaculture production 
df_CEFAS_UK_aquaculture_data <- vroom(file=paste(filepath,"CEFAS_UK_aquaculture-201320-edit.csv", sep="/"))

# Rename column
names(df_CEFAS_UK_aquaculture_data)[names(df_CEFAS_UK_aquaculture_data)=="Tonnes"] <- "Units"
```

```{r Transform and clean dataset (2013 to 2010)}
# Change structure of the dataset 
df_UK_aquaculture_201320_long<-melt(df_CEFAS_UK_aquaculture_data, id.vars = c("Type", "Species", "Units"), variable.name="Year", value.name="Value")

```

```{r Allocating fish species corresonding species type (2013 to 2010)}
# Allocate fish species group type 

```

```{r Load data (2009 to 2012)}
# UK aquaculture production 
df_CEFAS_UK_aqaculture_data <- vroom(file=paste(filepath,".csv", sep="/"))

```


```{r Transform and clean dataset (2009 to 2012)}
# Change structure of the dataset 
df_UK_aquaculture_201320_long<-melt(df_CEFAS_UK_aqaculture_data, id.vars = c("Type", "Species", "Units"), variable.name="Year", value.name="Value")

```

```{r Allocating fish species corresonding species type (2009 to 2012)}
# Allocate fish species group type 

```


```{r Add units and data source (2013 to 2020)}
# Create "cleaned" data frame, defining units and data source 
df_UK_aquaculture_201320_long$DataSource <- "CEFAS"
df_UK_aquaculture_201320_long$Dataset <- "Aquaculture"
df_UK_aquaculture_201320_long$Commodity <- "Production"
df_UK_aquaculture_201320_long$TempRes <- "Annual"
```

```{r Save cleaned data (CEFAS 2013 to 2020)}

```


### B) Aquaculture production (EUROSTAT)

```{r Load data (2009 to 2020)}
# UK aquaculture production 
df_EUROSTAT_UK_aquaculture_data <- vroom(file=paste(filepath,"EUROSTAT_UK_aquaculture-200920-edit.csv", sep="/"),na = c(".."))

```

```{r Allocating fish species corresonding species type (2009 to 2020)}
# Allocate fish species group type 

```


```{r Transform and clean dataset (2009 to 2020)}
# Change structure of the dataset 
df_EUROSTAT_UK_aquaculture_200920_long<-melt(df_EUROSTAT_UK_aquaculture_data, id.vars = c("Species"), variable.name="Year", value.name="Value")

```


```{r Add units and data source (Eurostat 2009 to 2020)}
# Create "cleaned" data frame, defining units and data source 
df_EUROSTAT_UK_aquaculture_200920_long$DataSource <- "Eurostat"
df_EUROSTAT_UK_aquaculture_200920_long$Dataset <- "Aquaculture"
df_EUROSTAT_UK_aquaculture_200920_long$Commodity <- "Production"
df_EUROSTAT_UK_aquaculture_200920_long$TempRes <- "Annual"
```

```{r Save cleaned data (Eurostat 2009 to 2020)}

```



## Trade (HMRC)

```{r Load data}

```


## UK fish consumption (NDNS)

```{r Load data}
# Read in NDNS data
df_NDNS_UK_data <- vroom(file=paste
                      (filepath,"NDNS_UK_consumption-edit.csv", sep="/"))

```

```{r Aggregate cohort information}
# Identify unique age cohorts
unique(df_NDNS_UK_data$`Age category`)

# Create a pipe aggregating sub age cohort totals, irrespective of sex 
all_sex <- df_NDNS_UK_data[df_NDNS_UK_data$`Age category` %in% c("Children 1.5-3 years", "Children 4-10 years", "Children 11-18 years", "Adults 19-64 years", "Adults 65 years and over"), ]

# Sum all subsetted cohorts 
df_clean_NDNS <- as.data.frame(colSums(all_sex[3:7])) 

colnames(all_sex)
df_clean_NDNS <- as.data.frame(colSums(all_sex[c("(2008/09 - 2009/10)", 
"(2010/11 - 2011/12)", "(2012/13 - 2013/14)", "(2014/15-2015/16)",  
"(2016/17-2018/19)"])))

df_clean_NDNS <- colSums(all_sex, c("(2008/09 - 2009/10)", 
"(2010/11 - 2011/12)", "(2012/13 - 2013/14)", "(2014/15-2015/16)",  
"(2016/17-2018/19)"), na.rm=TRUE)))

# Rename first column  

```

```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
df_clean_NDNS$Units <- "g/capita/day"
df_clean_NDNS$DataSource <- "NDNS"
df_clean_NDNS$Dataset <- "NDNS"
df_clean_NDNS$Commodity <- "Consumption"
df_clean_NDNS$TempRes <- "Biennial"
df_clean_NDNS$FishSpecies <- "Unknown"


```


```{r Save cleaned data}

```


## UK fish purchasing data (DEFRA and Kantar)

### A) DEFRA family food data sets

#### i) DEFRA UK purchases (both household and eating out)

```{r Load data 2015 to 2020} 
# read DEFRA purchasing (household and eating out) data (.csv)
df_DEFRA_purchase_201520_data <- vroom(file=paste(filepath,"DEFRA_UK_purchases-201520.csv", sep="/"))

# Separate purchasing data for household and eating out purposes based on code. Create a pipe aggregating fish products consumed within the household and eaten out
df_DEFRA_eaten_out_201520 <- df_DEFRA_purchase_201520_data[df_DEFRA_purchase_201520_data$codecat %in% c( "eo120101", "eo120102", "eo120201", "eo120202", "eo1203", "eo1204", "eo1205", "eo120601", "eo120602", "eo120603"), ]

df_DEFRA_household_201520 <- df_DEFRA_purchase_201520_data[df_DEFRA_purchase_201520_data$codecat %in% c( "10201", "10202", "10601", "10602", "10701", "10702", "10801", "11401", "11702", "11702", "118", "119", "120", "121", "12304", "12305"), ]

```

```{r Aggregate food groups}
# Identify unique major food groups
unique(df_DEFRA_household_201520$`Major Food Code`)

# Major food codes according to FAO groupings
df_DEFRA_household_201520$SpeciesType <- "Unknown"

#to fix
df_DEFRA_household_201520$SpeciesType[df_DEFRA_household_201520$codecat %in% c("10201", "10202", "11401"),] <- "Demersal"
df_DEFRA_household_201520$SpeciesType[df_DEFRA_household_201520$codecat %in% c("11702", "11703"),] <- "Shellfish"
df_DEFRA_household_201520$SpeciesType[df_DEFRA_household_201520$codecat %in% c("10601", "10602", "10701", "10702", "10801", "119"),]<-"Pelagic"

```



#### i) Household purchases (DEFRA 2009 to 2014)

```{r Load data (2009 to 2014)}
# read DEFRA household dataset (.csv)
df_DEFRA_household_data <- vroom(file=paste(filepath,"DEFRA_UK_household-200914-edited.csv", sep="/"))

# Select only years 2009 to 2014
df_DEFRA_household_200914 <- subset(df_DEFRA_household_data, 
                           select = c("Code", "Food Category", "Food Group",
                                      "Major Food Code", "Minor Food Code",
                                      "Units", "2009", "2010", "2011",
                                      "2012", "2013", "2014"))

```


```{r Aggregate food groups}
# Identify unique major food groups
unique(df_DEFRA_household_200914$`Major Food Code`)

# Major food codes according to FAO groupings
df_DEFRA_household_200914$SpeciesType <- "Unknown"
df_DEFRA_household_200914$SpeciesType[df_DEFRA_household_200914$`Major Food Code` == "White fish, fresh, chilled or frozen"] <- "Demersal"
df_DEFRA_household_200914$SpeciesType[df_DEFRA_household_200914$`Major Food Code` == "White fish, dried, salted or smoked"] <- "Demersal"
df_DEFRA_household_200914$SpeciesType[df_DEFRA_household_200914$`Major Food Code` == "Shellfish"] <- "Shellfish"
df_DEFRA_household_200914$SpeciesType[df_DEFRA_household_200914$`Major Food Code` == "Herrings and other blue fish, fresh, chilled or frozen"] <-"Pelagic"
df_DEFRA_household_200914$SpeciesType[df_DEFRA_household_200914$`Major Food Code` == "Salmon, fresh, chilled or frozen"] <- "Pelagic"
df_DEFRA_household_200914$SpeciesType[df_DEFRA_household_200914$`Major Food Code` == "Blue fish, dried or salted or smoked"] <- "Pelagic"
df_DEFRA_household_200914$SpeciesType[df_DEFRA_household_200914$`Major Food Code` == "Salmon, tinned"] <- "Pelagic"

# Remove rows where sum is provided 
df_DEFRA_household_200914_clean<-df_DEFRA_household_200914[!grepl("Sum", 
                                         df_DEFRA_household_200914$`Minor Food Code`),]

```

```{r Transform and clean dataset}
# Subset dataframe to include variables we want 
df_DEFRA_household_200914_main<-subset(df_DEFRA_household_200914_clean, select= c("Minor Food Code", "Units", "2009", "2010", "2011", "2012", "2013", "2014", "SpeciesType"))

# Change structure of the dataset 
df_DEFRA_household_200914_long<-melt(df_DEFRA_household_200914_main, id.vars = c("Minor Food Code", "Units", "SpeciesType"), variable.name="Year", value.name="Value")

# Combine household data (2009 to 2014 and 2015 to 2020)
df_DEFRA_household_long<-rbind(df_DEFRA_household_200914_long, )
```


```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
df_DEFRA_household_long$Units <- "g/capita/week"
df_DEFRA_household_long$DataSource <- "DEFRA"
df_DEFRA_household_long$Dataset <- "Family-Foods"
df_DEFRA_household_long$Commodity <- "Purchasing"
df_DEFRA_household_long$TempRes <- "Annual"

```


```{r Save cleaned data}

```


#### ii) Eating out (DEFRA 2009 to 2014)

```{r Load data (2009 to 2014)}
# read DEFRA eaten out data set
df_DEFRA_eaten_out_data <- vroom(file=paste(filepath,"DEFRA_UK_eatenOut-200914-edited.csv", sep="/"))

# Select only years 2009 to 2014
df_DEFRA_EO_200914 <- subset(df_DEFRA_eaten_out_data, 
                           select = c("Code", "EO Food Group", 
                                      "EO Major code", "EO Minor code",
                                      "Units", "2009", "2010", "2011",
                                      "2012", "2013", "2014"))
```


```{r Aggregate food groups}

# Identify unique major food groups
unique(df_DEFRA_EO_200914$`EO Major code`)

# Major food codes according to FAO groupings.
df_DEFRA_EO_200914$SpeciesType <- "Unknown"
df_DEFRA_EO_200914$SpeciesType[df_DEFRA_EO_200914$`EO Major code` == "White fish"] <- "Demersal"
df_DEFRA_EO_200914$SpeciesType[df_DEFRA_EO_200914$`EO Major code` == "Shellfish - without sauce or dressing (e.g. prawns, shrimps, oysters, crab)"] <- "Shellfish"
df_DEFRA_EO_200914$SpeciesType[df_DEFRA_EO_200914$`EO Major code` == "Fatty fish"] <- "Pelagic"
df_DEFRA_EO_200914$SpeciesType[df_DEFRA_EO_200914$`EO Major code` == "Kippers and other smoked fish (e.g. smoked salmon)"] <- "Pelagic"

# Remove rows where sum is provided 
df_DEFRA_EO_200914_clean<-df_DEFRA_EO_200914[!grepl("Sum", 
                                         df_DEFRA_EO_200914$`EO Minor code`),]

```

```{r Transform and clean dataset}
# Subset dataframe to include variables we want 
df_DEFRA_EO_200914_main<-subset(df_DEFRA_EO_200914_clean, select= c("EO Minor code", "Units", "2009", "2010", "2011", "2012", "2013", "2014", "SpeciesType"))

# Change structure of the dataset 
df_DEFRA_EO_long<-melt(df_DEFRA_EO_200914_main, id.vars = c("EO Minor code", "Units", "SpeciesType"), variable.name="Year", value.name="Value")
```


```{r Add units and data source}
# Create "cleaned" data frame, defining units and data source 
df_DEFRA_EO_long$Units <- "g/capita/week"
df_DEFRA_EO_long$DataSource <- "DEFRA"
df_DEFRA_EO_long$Dataset <- "Family-Foods"
df_DEFRA_EO_long$Commodity <- "Purchasing"
df_DEFRA_EO_long$TempRes <- "Annual"

```


```{r Save cleaned data}

```


### B) Kantar 



######## Code not needed 

### B) Aquaculture production (Marine Scotland and DEFRA)

```{r Load data (Scotland: Marine Scotland Science)}
# a) Aquaculture production in Scotland
# i) salmon, ii) rainbow trout, iii) shellfish
df_MSS_salmon_data <- vroom(file=paste(filepath,"MSS_Scotland_aquacultureSalmon.csv", sep="/"), na = c(".."))

df_MSS_rainbowTrout_data <- vroom(file=paste(filepath,"MSS_Scotland_aquacultureRainbowTrout.csv", sep="/"), na = c(".."))

df_MSS_shellfish_data <- vroom(file=paste(filepath,"MSS_Scotland_aquacultureShellfish.csv", sep="/"), na = c(".."))

```

```{r Subset data (Scotland: Marine Scotland Science)}
# Determine products are for human consumption 
df_MSS_shellfish_HC <- subset(df_MSS_shellfish_data, Production == "For the table")

# Subset data between 2009 and 2021 
df_MSS_salmon <- subset(df_MSS_salmon_data, Year > 2008, 
                        select= c(Year, Tonnes)) 

df_MSS_rainbowTrout <- subset(df_MSS_rainbowTrout_data, Year > 2008, 
                        select= c("Year", "Total Tonnes"))

df_MSS_shellfish <- subset(df_MSS_shellfish_HC, Year > 2008)

# State species, unit and data source
df_MSS_salmon$Units <- "tonnes"
df_MSS_salmon$Species <- "Salmon"
df_MSS_salmon$SpeciesType <- "Diadromous"

df_MSS_rainbowTrout$Units <- "tonnes"
df_MSS_rainbowTrout$Species <- "RainbowTrout"
df_MSS_rainbowTrout$SpeciesType <- "Freshwater"

df_MSS_shellfish$Units <- "Varied"
df_MSS_shellfish$Species <- "Varied"
df_MSS_rainbowTrout$SpeciesType <- "Shellfish"

```

```{r Combine Scottish aqacualture production data}

#df_MMS_production<- merge(df_MSS_salmon, df_MSS_rainbowTrout)

```


```{r Add units and data source (Scotland: Marine Scotland Science)}
# Create "cleaned" data frame, defining units and data source 

#df_clean_UK_landings_09_20$Units <- "tonnes or numbers"
df_MMS_production$DataSource <- "Marine_Scotland"
df_MMS_production$Dataset <- "Scottish-aquaculture"
df_MMS_production$Commodity <- "Production"
df_MMS_production$TempRes <- "Annual"
```