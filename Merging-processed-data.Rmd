---
title: "Part 2. Merging cleaned data. RI-B5-04: UK seafood supply chains"
author: "A.Lofstedt"
date: "25/01/2023"
output: html_document
---

```{r setup, include=FALSE}
# sets options for entire document in the first chunk
knitr::opts_chunk$set(echo = TRUE)
```

## Part 2: Merging processed data to map UK seafood supply chains

This R markdown document outlines how the cleaned data quantifying seafood production (both capture and aquaculture), trade, consumption and purchasing behavior between 2009 and 2018 was merged for analysis. Two data frames are created- one with seafood supplies expressed in grams and another expressed in g/ capita/ week 

## Preparation

```{r Load libraries, include=FALSE}
# Load packages
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(stringr) # used to replace matched patterns in a string
```


```{r Load file path, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```


```{r Specify the desired file path}
filepath <- paste(data_dir,"ProcessedData", sep = "") 
# note we are able to change this to another file e.g. saving the output
```


Note to AL: check the time series of the data set- should be between 2009 to 2018. Do this step now.  



```{r Load cleaned data}
# Load UK capture production data (UK landings into UK only)
#df_captureProd_NS_clean_data <- vroom(file = paste(filepath,"UKLandingsinUKOnly_MMO_clean.csv", sep = "/"))

# Load UK capture production data (UK and foreign vessels landings into the UK)
df_allLandingsintoUK_NS_clean_data <- vroom(file = paste(filepath,"AllLandingsintoUK_MMO_clean.csv", sep = "/"))

# Load UK capture production data (UK landings into the UK and abroad)
#df_LandingsUKAbroad_NS_clean_data <- vroom(file = paste(filepath,"LandingsUKAndAbroad_MMO_clean.csv", sep = "/"))

# Load UK aquaculture production data 
df_aquaProd_Eurostat_clean_data <- vroom(file = paste(filepath,"AquacultureData_Eurostat_clean.csv", sep = "/"))

# Load UK trade data (further processed)
df_trade_HMRC_clean_data <- vroom(file = paste(filepath,"TradeData_HMRC_clean.csv", sep = "/"))

# Load UK household purchasing data 
df_housePurch_DEFRA_clean_data <- vroom(file = paste(filepath,"HouseholdPurchases_DEFRA.csv", sep = "/"))

# Load UK eating out purchasing data 
df_eatenOutPurch_DEFRA_clean_data <- vroom(file = paste(filepath,"EatenOutPurchases_DEFRA.csv", sep = "/"))

# Load UK consumption data 
df_consumption_NDNS_clean_data <- vroom(file = paste(filepath,"ConsumptionData_NDNS_clean.csv", sep = "/"))

# Load UK population data 
df_popSize_NS_clean_data <- vroom(file = paste(filepath,"PopSize_NS.csv", sep = "/"))

```



## UK seafood supplies (grams)

Create a data frame calculating UK seafood supplies per year. Units are displayed as grams.

```{r Combine all data frames}
# rbind() cleaned data frames by column names
df_UKSeafoodSupplies <- rbind(df_captureProd_NS_clean_data, df_aquaProd_Eurostat_clean_data, df_trade_HMRC_clean_data, df_housePurch_DEFRA_clean_data, df_eatenOutPurch_DEFRA_clean_data, df_consumption_NDNS_clean_data)

df_UKSeafoodSupplies <- rbind(df_allLandingsintoUK_NS_clean_data, df_aquaProd_Eurostat_clean_data, df_consumption_NDNS_clean_data)

colnames(df_allLandingsintoUK_NS_clean_data)
colnames(df_aquaProd_Eurostat_clean_data)
colnames(df_consumption_NDNS_clean_data)
colnames(df_trade_HMRC_clean_data)

```


```{r Save cleaned data}
# Change file path to "ProcessedData". Can also use setwd()
filepath <- paste(data_dir,"ProcessedData", sep = "")
write.csv(df_UKSeafoodSupplies, file = paste(filepath,"UKSeafoodSupplies_clean.csv", sep = ""))

```



## UK Seafood supplies per capita (g/capita/ week)

Create a new data frame calculating UK seafood supplies per capita per week. Units are displayed as grams per capita per week.

Download and clean UK population data. 

```{r Load data}
# Read in UK population data 
df_NS_UK_pop_data <- vroom(file=paste(filepath,"PopSize_NS.csv", sep="/"))
colnames(df_NS_UK_pop_data)

# Select desired columns from data set
df_NS_UK_pop <- df_NS_UK_pop_data[c("CDID", "UKPOP")]

# Rename columns 
colnames(df_NS_UK_pop) <- c("Year", "UKPop")
str(df_NS_UK_pop)

```


```{r Calculate grams available per capita}
# Add in annual UK population data to the data frame as a new column. Duplicate population data for each year. 

# Match population size per year to each year in the merged seafood data frame
df_UKSeafoodPerCapita <- merge(df_UKSeafoodSupplies, df_NS_UK_pop, by = "Year")

# Convert grams/year to g/capita/year
df_UKSeafoodPerCapita$ValueGramsCapitaYear <- df_UKSeafoodPerCapita$ValueGrams / df_UKSeafoodPerCapita$UKPop

# Convert grams/year to g/capita/week
df_UKSeafoodPerCapita$Value <- df_UKSeafoodPerCapita$ValueGramsCapitaYear / 52

# Add additional column stating the units
df_UKSeafoodPerCapita$Units <- "GramsCapitaWeek"

```


```{r Save cleaned data}
# Change file path to "ProcessedData". Can also use setwd()
filepath <- paste(data_dir,"ProcessedData", sep = "")
write.csv(df_UKSeafoodPerCapita, file = paste(filepath,"UKSeafoodPerCapita.csv", sep = ""))

```

