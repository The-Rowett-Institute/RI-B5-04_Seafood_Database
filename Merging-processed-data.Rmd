---
title: "Merging-processed-data"
author: "A.Lofstedt"
date: "2022-11-01"
output: html_document
---

```{r setup, include=FALSE}
# sets options for entire document in the first chunk
knitr::opts_chunk$set(echo = TRUE)
```

## Part 2: Merging processed data to map UK seafood supply chains

This R Markdown document (part 2) outlines how the data processed is merged together.

## Preparation

```{r Load libraries, include=FALSE}
# Load packages
library(tidyr)
library(dplyr)
library(vroom) # for loading and transforming data
library(tidyverse)
library(reshape2)

```

```{r Load data, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```

```{r Specify the desired file path}
filepath <- paste(data_dir,"ProcessedData", sep="") 
# note we are able to change this to another file e.g. saving the output

```

## Merge processed data sheets

```{r Load data}
# Read in UK capture production data 
df_wildProd_NS_data <- vroom(file=paste(filepath,"ProductionData_NS-edit.csv", sep="/"))
str(df_wildProd_NS_data)

# Read in UK aquaculture data 
df_aquaProd_Eurostat_data <- vroom(file=paste(filepath,"AquacultureData_Eurostat.csv", sep="/"))
str(df_aquaProd_Eurostat_data)

# Read in UK trade data--- further processed 
df_trade_HMRC_data <- vroom(file=paste(filepath,"TradeData_HMRC-edits.csv", sep="/"))
str(df_trade_HMRC_data)

# Read in UK household purchasing data 
df_housePurch_DEFRA_data <- vroom(file=paste(filepath,"HouseholdPurchases_DEFRA_edit.csv", sep="/"))
str(df_housePurch_DEFRA_data)

# Read in UK eating out purchasing data 
df_eatenOutPurch_DEFRA_data <- vroom(file=paste(filepath,"EatenOutPurchases_DEFRA.csv", sep="/"))
str(df_eatenOutPurch_DEFRA_data)

# Read in UK population size data 
df_popSize_NS_data <- vroom(file=paste(filepath,"PopSize_NS.csv", sep="/"))
str(df_popSize_NS_data)

```

```{r Check structure of dataframes}
# See individual column names
colnames(df_wildProd_NS_data)
colnames(df_housePurch_DEFRA_data)
colnames(df_eatenOutPurch_DEFRA_data)
colnames(df_trade_HMRC_data)

# Rename species coulmn in aquculture dataset 
df_aquaProd_Eurostat_data <- rename(df_aquaProd_Eurostat_data, Species= SimplifiedSpecies)

```

```{r Identify unique species names in the data set}
# Identify unique species in the data set 
captureFish_NS <- as.data.frame(sort(unique(df_wildProd_NS_data$Species)))
farmedFish_Eurostat <- as.data.frame(sort(unique(df_aquaProd_Eurostat_data$SimplifiedSpecies)))
trade_HMRC <- as.data.frame(sort(unique(df_trade_HMRC_data$Species)))
checkSpeciesNames <- cbind(trade_HMRC, farmedFish_Eurostat, captureFish_NS)

getwd()
write.csv(captureFish_NS, file= "NS_speciesNames")
write.csv(farmedFish_Eurostat, file= "Eurostat_speciesNames")
write.csv(trade_HMRC, file= "HMRC_speciesNames")

```





```{r Merge data set by column names}
# Merge dataframes
UK_seafood_data <- rbind(df_wildProd_NS_data, df_aquaProd_Eurostat_data, df_housePurch_DEFRA_data, df_eatenOutPurch_DEFRA_data, df_trade_HMRC_data)

str(UK_seafood_data)

```

```{r Plot average lean fish capture production (g/capita/day) between 2009 and 2020}

# Subset lean capture fishery production in the UK
prod_lean <- subset(df_wildProd_NS_data, SACN == "Lean", select = c(Year, ValueGramsCapitaDay))

# Subset lean capture fishery production in the UK
prod_oily <- subset(df_wildProd_NS_data, SACN == "Oily", select = c(Year, ValueGramsCapitaDay))

plot(aggregate(ValueGramsCapitaDay ~ Year, data = df_wildProd_NS_data, mean)) # all fish produced 

# Plot lean fish only 
plot(aggregate(ValueGramsCapitaDay ~ Year, data = prod_lean, mean), ylim= c(0, 0.65), col= "red") + points(aggregate(ValueGramsCapitaDay ~ Year, data = prod_oily, mean), col = "blue")


plot(aggregate(ValueGramsCapitaDay ~ Year, data = prod_oily, mean))

```

```{r Figure 1. UK fish production (capture and aqaucualture data)}
# Plot UK seafood production (merge capture and aquaculture data together) 
UK_production_data <- rbind(df_wildProd_NS_data, df_aquaProd_Eurostat_data)
range(df_wildProd_NS_data$Year)
range(df_aquaProd_Eurostat_data$Year) # data only till 2018

# Calculate fish produced per week 
UK_production_data$ValueGramsCapitaWeek <- UK_production_data$ValueGramsCapitaDay*7

# Plot UK fisheries production data between 2009 and 2020
plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_production_data, FUN = sum), xlim = c(2009, 2018), type= "l", lwd= 1.5, ylab = "UK seafood production (g/capita/week)")
```

```{r Figure 2. UK farmed salmon production}
# UK farmed salmon production
# Calculate fish produced per week
farmed_salmon <- subset(df_aquaProd_Eurostat_data, Species == "Atlantic salmon")
farmed_salmon$ValueGramsCapitaWeek <- farmed_salmon$ValueGramsCapitaDay*7

# Plot UK farmed salmon production
plot(ValueGramsCapitaWeek ~ Year, data = farmed_salmon, xlim = c(2009, 2018), type= "l",lwd= 1.5, ylab = "UK salmon production (edible portion g/capita/week)")

```

```{r Figure 3. UK cod capture production}
# UK capture cod production
# Calculate fish produced per week
wild_cod <- subset(df_wildProd_NS_data, Species == "Cod")
wild_cod$ValueGramsCapitaWeek <- wild_cod$ValueGramsCapitaDay*7

# Reorder data set according to Year
wild_cod2 <- wild_cod[order(wild_cod$Year), ]

# Plot UK farmed salmon production
plot(ValueGramsCapitaWeek ~ Year, data = wild_cod2, xlim = c(2009, 2020), type= "l", lwd= 1.5, ylab = "UK cod production (edible portion g/capita/week)")

```

```{r Figure 4. UK seafood trade}
# Subset trade data in to separate commodities 
UK_imports <- subset(df_trade_HMRC_data, Commodity == "Imports")
UK_exports <- subset(df_trade_HMRC_data, Commodity == "Exports")

plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_imports, FUN = sum), xlim = c(2009, 2019), type= "l", lwd= 1.5, ylab = "UK fish imports (g/capita/week)")

plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_exports, FUN = sum), xlim = c(2009, 2019), type= "l", lwd= 1.5, ylab = "UK fish exports (g/capita/week)")


# Plot on same graph
plot(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_exports, FUN = sum), ylim= c(0,16), xlim = c(2009, 2019), type= "l", lwd= 1.5, ylab = "UK fish traded (g/capita/week)", col= "red") +
  lines(aggregate(ValueGramsCapitaWeek ~ Year, data = UK_imports, FUN = sum), col= "blue") + legend("topright", legend =  c("Import", "Export"), fill = c("blue", "red"))


```

```{r Figure 5. UK fish purchases (houshold and eaten out)}
# Create data frame combining fish purchase data
fish_purchases <- rbind(df_housePurch_DEFRA_data, df_eatenOutPurch_DEFRA_data)

plot(aggregate(ValueGramsCapitaDay ~ Year, data = df_housePurch_DEFRA_data, FUN = sum))
plot(aggregate(ValueGramsCapitaDay ~ Year, data = df_eatenOutPurch_DEFRA_data, FUN = sum))

# Calculate fish purchased per week
fish_purchases$ValueGramsCapitaWeek <- fish_purchases$ValueGramsCapitaDay*7

plot(aggregate(ValueGramsCapitaWeek ~ Year, data = fish_purchases, FUN = sum), xlim = c(2009, 2020), type= "l", lwd= 1.5, ylab = "UK fish purchases (g/capita/week)")

# Interesting with 2020 data- reduction in fish purchases

```



## Checking the trade HMRC dataset [delete later]

```{r Load relevant packages}
library(vroom) # for loading and transforming data
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
```


```{r Load HMRC data}
# Filepath to RawData
filepath <- paste(data_dir,"RawData/csv-files", sep="")
# reading the HRMC trade data dataset (.csv)
#df_HRMC_2009 <- vroom(file=paste(filepath,"HMRC_UK_trade-2009.csv", sep="/"))
vec_filenames_HMRC <- list.files(filepath, pattern = "HMRC_UK_trade", full.names = TRUE)
print("The following files were loaded:")
```


```{r Extract data (multiple excel spreadsheets) from data file}
i = 1
# Loading the cleaned dataset
for(f in vec_filenames_HMRC){
temp <- fread(f) # storing the data in a temporary
assign(paste("df_HMRC_",i,sep=""),temp) # assigning the df a name based on input dataset
print(paste(i,". ",sub(paste(".*",filepath,sep=""),"",f),sep="")) # print out which dataset files had been used
i = i+1
rm(temp)# removing temp object
}
```


```{r Combine multiple data sets into one data frame}
rm(i)
# Next step is to combine this all into big HMRC data.frame
df_HRMC_2009_to_2019 <- bind_rows(df_HMRC_1, df_HMRC_2, df_HMRC_3, df_HMRC_4, df_HMRC_5, df_HMRC_6)
rm(df_HMRC_1, df_HMRC_2, df_HMRC_3, df_HMRC_4, df_HMRC_5, df_HMRC_6) # removing the unneeded df

# Check for NA's in the data set
md.pattern(df_HRMC_2009_to_2019, rotate.names = TRUE)
```


## Loading the EUMOFA data

We use the EUMOFA data as a help to facilitate the classification and translation of the HRMC CN-8 codes in to our desired species and species type. The EUMOFA has a classification mapped to each CN-8 code. Using this, instead of crawling through the HMRC “Product name”-column and searching for specific key words its text, will mitigate a lot of potential miss-classification. As the HMRC “Product name”, does not seem to use controlled vocabulary and has various spelling version of the same word (plural & single) included.
[MAYBE MORE DETAILS ON EUMOFA DATA HERE]



```{r Load EUMOFA file }

# Filepath to EUMOFA-file with complete CN-8 codes
filepath <- paste(data_dir,"Methods/SpeciesTypeClassification", sep="")
# reading the EUMOFA-file
df_EUMOFA_CN8 <- vroom(file=paste(filepath,"EUMOFA_CN-8-values.csv", sep="/"))
```


```{r Load Annex 4}
# We are also loading the Annex 4 from the Metadata 2 - Data management EUFOMA https://www.eumofa.eu/supply-balance-and-other-methodologies
# ANNEX 4 Correlation between Main commercial species(MCS)/Commodity Groups (CG) and CN-8 from 2001 to 2022 Revision 1.2
df_EUMOFA_CN8_MCS_CG <- vroom(file=paste(filepath,"EUMOFA_Annex4.csv", sep="/"))

```


```{r Load species classification file}
# loading Species classification - translation from EUMOFA MCS & CG to the classification we want to use.
df_Species_Class <- vroom(file=paste(filepath,"SpeciesTypeClassificationCode.csv", sep="/"))
```


```{r Check for missing values}
# Check for missing values
md.pattern(df_EUMOFA_CN8_MCS_CG, rotate.names = TRUE)

md.pattern(df_Species_Class, rotate.names = TRUE)

md.pattern(df_EUMOFA_CN8, rotate.names = TRUE)

```


We have 25 missing (NA) values in the EUMOFA dataset, 20 in the “Explanation”-column and 5 in the
“CN-8 product name”-column. As annoying as NA-values are, in this instance we can ignore them. As these values are irrelevant for us and the next steps, since the EUMOFA Annex 4 dataset has no NA-values and the main commercial species (MCS) and commodity groups (CG) for the respective CN-8 code.


## Processing the data

```{r}
# need to remove the space from the 'CN-8'-column. But leave it as character, so we don't loose the "0" at the beginning of the CN8 code
# https://stackoverflow.com/questions/20309876/r-how-to-replace-in-a-string
df_EUMOFA_CN8$`CN-8` <- gsub("\\ ","", df_EUMOFA_CN8$`CN-8`)
#df_EUMOFA_CN8_2009 <- df_EUMOFA_CN8 %>% filter(Year %in% "2009" )
print("FYI: In the EUMOFA CN-8 product name-Column are large - symbols, which R does not recognize replaces them with ? in a square")
```

```{r}
# Need to separate the CN8 code from the description in the CN8-column of the HMRC data
df_HRMC_2009_to_2019$Subset_aid_CN8 <- gsub(" .*$", "", df_HRMC_2009_to_2019$CN8)

# subset string before white space

# Thanks to our psychic abilities, we know that one of the CN8-codes in the HRMC Uk trade is missing its lead 0. And we need to deal with that.

# Check what will not be joined
df_HMRC_anti <- df_HRMC_2009_to_2019 %>% select('Net Mass (Kg)', 'Flow Type', 'Year','Month', 'Subset_aid_CN8', 'CN8') %>% anti_join(.,df_EUMOFA_CN8, by = c('Subset_aid_CN8' = 'CN-8'))

#The following CN8 code items were not joined
unique(df_HMRC_anti$CN8)
```

It is item [2] “3074959”, were we need to add a lead zero.

```{r}
# adding the lead 0 to "3074959" in the HRMC UK trade data
df_HRMC_2009_to_2019$Subset_aid_CN8 <- str_replace(df_HRMC_2009_to_2019$Subset_aid_CN8,"3074959","03074959")
```


```{r Tidy "Flow Type" column}
# "Flow Type" column is separate into "EU" and "Non-EU" imports and exports
# Origin does not need to be specified
# Removed "Non EU - "
df_HRMC_2009_to_2019$`Flow Type` <- str_replace(df_HRMC_2009_to_2019$`Flow Type`,"Non EU - ","") 
unique(df_HRMC_2009_to_2019$`Flow Type`)

# Remove "EU - ". (needs to be first. Or else line 83 will remove "EU" from "Non EU -")
df_HRMC_2009_to_2019$`Flow Type` <- str_replace(df_HRMC_2009_to_2019$`Flow Type`,"EU - ","")
```


```{r Tidy "Flow Type" column}
# Join the HMRC trade data and the EUMOFA data
df_HMRC_inner <- df_HRMC_2009_to_2019 %>% select('Net Mass (Kg)', 'Flow Type', 'Year','Month', 'Subset_aid_CN8') %>% inner_join(.,df_EUMOFA_CN8, by = c('Subset_aid_CN8' = 'CN-8', 'Year' ))

# Calculate annual sum, selecting needed columns and converting to Net Mass from kg to 1000 tonnes
df_HRMC.sum <- df_HMRC_inner %>% group_by(CN8 = Subset_aid_CN8,`Product name` =`CN-8 product name`, Year = Year, Commodity =`Flow Type`, CF) %>% summarise(`Net Mass (1000 t)`= sum(`Net Mass (Kg)`)/1000000,`Net Mass (kg)`= sum(`Net Mass (Kg)`))

```



```{r}
rm(df_HMRC_inner)
df_HMRC_4DB <-df_HRMC.sum
# mapping EUMOFA Main Commercial Species (MCS) and Commodity Group (CG) classification
df_HMRC_4DB <- df_HMRC_4DB %>% inner_join(., df_EUMOFA_CN8_MCS_CG, by = c('CN8' = 'CN8 code', 'Year'))
# Mapping our desired Species Species Type classification
df_HMRC_4DB <- df_HMRC_4DB %>% inner_join(., df_Species_Class, by = c('MCS_descr' = 'EUMOFA_MCS'))
```

```{r}

# We will now need to aggregated the weight values for some species again. As we have aggregate some some of the species and species type e.g. atlantic & pacific salmon as just salmon
df_HRMC.sum <- df_HMRC_4DB %>% group_by(Species = EUMOFA_MCS_AL, SpeciesType = SpeciesType_AL, Year, Commodity) %>% summarise(`Net Mass (1000 t)`= sum(`Net Mass (kg)`)/1000000,`Net Mass (kg)`= sum(`Net Mass (kg)`))
```


```{r Add additional variables to the data set}
df_HMRC_4DB <- df_HRMC.sum
# Adding DataSupplier information
df_HMRC_4DB$DataSupplier <- "HMRC"
df_HMRC_4DB$DataSet <- "HMRC Overseas Trade data table - UK Trade Info"
#determining if the Fish is for Human consumption or not based on the CF from the EUMOFA-file
df_HMRC_4DB <- rename(df_HMRC_4DB, Value =`Net Mass (1000 t)`)
df_HMRC_4DB$Units <- "1000 tonnes"
df_HMRC_4DB$TemporalResolution <- "Annual"
df_HMRC_4DB$Flag <- "EXAMPLES: UC, SSTAlig"
df_HMRC_4DB$FlagDescription <- "EXAMPLES:Units changed, Species & Species Type aligned"
```


```{r}
# Selecting Columns
df_HMRC_4DB <- df_HMRC_4DB %>% ungroup %>% select(DataSupplier, DataSet, Commodity, Species, SpeciesType, Value, Units, Year, TemporalResolution, Flag, FlagDescription)

# Removing Non-food uses im- & exports
df_HMRC_4DB <- df_HMRC_4DB %>% filter(!SpeciesType %in% "OtherNFU")
```


```{r Save cleaned data frame}
filepath <- paste(data_dir,"ProcessedData", sep="")
write.csv(df_HMRC_4DB, paste(filepath,"TradeData_HMRC_Preliminary-Cleaned.csv", sep="/"), row.names = FALSE)

```

