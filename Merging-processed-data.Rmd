---
title: "RI-B5-04: UK seafood supply chains. Creation of a UK Seafood supply chain database"
author: "B. Scheliga and A.Lofstedt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This is a document describes the methods and data used to create the UK Seafood supply chain database, linking  
both capture and aquaculture), trade, consumption and purchasing behavior between 2009 and 2018.

This project was part of the RESAS - Project from the Rowett Institute at the University of Aberdeen.

Two data frames are created- one with seafood supplies expressed in grams and another expressed in g/ capita/ week 


## Preparation

```{r Load libraries}
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(stringr) # used to replace matched patterns in a string

```


```{r Load cleaned data}
# loading filepath to the project folder on the University storage
source("Data_filepath.R")

# Only selecting the cleaned dataset, which are annotate with the "_cleaned_sfdb". There might be other processed files in the folder, which we don't want
filepath <- paste(data_dir,"ProcessedData/", sep="")# we are storing the file path here, because we'll need it later
vec_filenames_sfdb <- list.files(filepath, pattern = "Cleaned.csv", full.names = TRUE)


print("The following files were loaded:")
i = 1
# Loading the cleaned dataset
for(f in vec_filenames_sfdb){
    temp <- fread(f) # storing the data in a temporary 
    assign(paste("df_",substr(sub(paste(".*",filepath,sep=""),"",f),1,6),sep=""),temp) # assigning the df a name based on input dataset
    print(paste(i,". ",sub(paste(".*",filepath,sep=""),"",f),sep="")) # print out which dataset files had been used
    i = i+1
    rm(temp)# removing temp object
}
rm(i)

```


## Create seafood database

```{r rbind all cleaned datasets}
df_Seafood_DB <- rbind(df_Trade_, df_AllLan)# Note df_Trade_ is the edited one

df_Seafood_DB <- rbind(df_TradeD, df_UKVess) # Note df_Trade_ is the edited one
df_Seafood_DB <- rbind(df_Seafood_DB, df_Aquacu)
df_Seafood_DB <- rbind(df_Seafood_DB,df_Consum)
df_Seafood_DB <- rbind(df_Seafood_DB,df_EatenO)
df_Seafood_DB <- rbind(df_Seafood_DB,df_Househ)
df_Seafood_CoPu_DB <- rbind(df_Consum,df_EatenO)
df_Seafood_CoPu_DB <- rbind(df_Seafood_CoPu_DB,df_Househ)
```


```{r Save the seafood database}
source("Data_filepath.R")
# Save datframe to "Outputs" data file
filepath <- paste(data_dir,"Outputs", sep="")
write.csv(df_Seafood_DB, paste(filepath,"Seafood-database_preliminary.csv",sep="/"), row.names = FALSE)
```



## Up t ohere

```{r Specify the desired file path}
filepath <- paste(data_dir,"ProcessedData", sep = "") 
# note we are able to change this to another file e.g. saving the output
```

```{r Load population data}
# Load database 
df_UK_population <- vroom(file=paste(filepath,"UKPopulation_ONS_PreliminaryCleaned.csv", sep="/"), na = c("NA"))
```


```{r Specify the desired file path}
filepath <- paste(data_dir,"Outputs", sep = "") 
# note we are able to change this to another file e.g. saving the output
```

```{r Load the seafood database}
# Load database 
df_UK_seafoodDB <- vroom(file=paste(filepath,"Seafood-database_preliminary.csv", sep="/"), na = c("NA"))
```


## Final clean of the dataset

Remove products for non-human consumption nor are included in the dietary recommendations 

```{r Final clean}
# Check the unique species types
unique(df_UK_seafoodDB$SpeciesType)

# Remove species type products not included in dietary recommendations e.g. "Fish meal", "white fish", "fish oil", "Seaweed and other algae". Remove products for non-human consumption. Remove 2019 data
df_UK_seafoodDB_food <- subset(df_UK_seafoodDB, SpeciesType != "Fish oil" & SpeciesType != "Seaweed and other algae" & Species != "Fishmeal" & Species != "Caviar, livers and roes" & Species != "White fish" & Species != "Surimi" & Year != 2019)
```



```{r Change structure of the data frame}
# See pivot_wider()/ spread() command in tidyverse to change structure. 
# See dplyr cheat sheet.

# Simplify data set and select desired columns 
df_UK_seafoodDB_food_spec <- df_UK_seafoodDB_food[c("Species", "SpeciesType", "SACN", "Year", "Commodity", "Value" )]

# Aggregate value by commodity, year and species (production data composed of aquaculture and wild capture)
df_UK_seafoodDB_food_simp <- aggregate(Value ~ Commodity + Year + Species + SpeciesType + SACN, data = df_UK_seafoodDB_food_spec, sum)

# Make data frame wide and short
df_UK_seafoodDB_short <- df_UK_seafoodDB_food_simp %>%
  pivot_wider(names_from = Commodity, values_from = Value)

```


```{r Combine database with UK population data}
# Merge seafood database with UK population data
df_UK_seafoodDB_Pop <- merge(df_UK_seafoodDB_short, df_UK_population, by = "Year")

# Simplify data set and select desired columns 
df_UK_seafoodDB_capita <- df_UK_seafoodDB_Pop[c("Species", "SpeciesType", "SACN", "Year", "Production",
                                                   "Exports","Imports", "Consumption","Purchases",
                                                   "UKPOP")]

```


## Calculate UK seafood supplies (g/capita/week)

```{r Calculate seafood supplies (g/capita/week)}
# Convert NA to zeros (otherwise supplies cannot be calculated)
df_UK_seafoodDB_capita[is.na(df_UK_seafoodDB_capita)] <- 0

# Calculate seafood supplies
df_UK_seafoodDB_capita$Supplies <- (df_UK_seafoodDB_capita$Production + df_UK_seafoodDB_capita$Imports) - df_UK_seafoodDB_capita$Exports

# Calculate seafood supplied per capita per week
df_UK_seafoodDB_capita$Supplies_capitaWeek <- (df_UK_seafoodDB_capita$Supplies/ df_UK_seafoodDB_capita$UKPOP)/52

# Calculate seafood supplied per capita per day
df_UK_seafoodDB_capita$Supplies_capitaDay <- (df_UK_seafoodDB_capita$Supplies/ df_UK_seafoodDB_capita$UKPOP)/365

# Calculate seafood consumed per capita per week 
df_UK_seafoodDB_capita$Consumption_capWeek <- (df_UK_seafoodDB_capita$Consumption/ df_UK_seafoodDB_capita$UKPOP)/52

# Calculate seafood consumed per capita per day 
df_UK_seafoodDB_capita$Consumption_capWeek <- (df_UK_seafoodDB_capita$Consumption/ df_UK_seafoodDB_capita$UKPOP)/365

```

```{r}
# Merge nutrient data with seafood database
df_seafood_compDB <- merge(df_UK_seafoodDB_capita, df_seafoodCompSimp, "Species")

```




