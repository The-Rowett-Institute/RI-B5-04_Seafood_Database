---
title: "Part 2. Merging cleaned data. RI-B5-04: UK seafood supply chains"
author: "A.Lofstedt"
date: "24/01/2023"
output: html_document
---

```{r setup, include=FALSE}
# sets options for entire document in the first chunk
knitr::opts_chunk$set(echo = TRUE)
```

## Part 2: Merging processed data to map UK seafood supply chains

This R markdown document outlines how the cleaned data quantifying seafood production (both capture and aquaculture), trade, consumption and purchasing behavior between 2009 and 2018 was merged for analysis. Two data frames are created- one with seafood supplies expressed in grams and another expressed in g/ capita/ week 

## Preparation

```{r Load libraries, include=FALSE}
# Load packages
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(stringr) # used to replace matched patterns in a string
```


```{r Load file path, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```


```{r Specify the desired file path}
filepath <- paste(data_dir,"ProcessedData", sep = "") 
# note we are able to change this to another file e.g. saving the output
```


Note to AL: check the time series of the data set- should be between 2009 to 2018. Do this step now.  



```{r Load cleaned data}
# Load UK capture production data 
df_captureProd_NS_clean_data <- vroom(file = paste(filepath,"AllLandingsUKProductionData_MMO_clean.csv", sep = "/"))

# Load UK aquaculture production data 
df_aquaProd_Eurostat_clean_data <- vroom(file = paste(filepath,"AquacultureData_Eurostat_clean.csv", sep = "/"))

# Load UK trade data (further processed)
df_trade_HMRC_clean_data <- vroom(file = paste(filepath,"Trade_HMRC_clean.csv", sep = "/"))

# Load UK household purchasing data 
df_housePurch_DEFRA_clean_data <- vroom(file = paste(filepath,"HouseholdPurchases_DEFRA.csv", sep = "/"))

# Load UK eating out purchasing data 
df_eatenOutPurch_DEFRA_clean_data <- vroom(file = paste(filepath,"EatenOutPurchases_DEFRA.csv", sep = "/"))

# Load UK consumption data 
df_consumption_NDNS_clean_data <- vroom(file = paste(filepath,"ConsumptionData_NDNS_clean-edited.csv", sep = "/"))

# Load UK population data 
df_popSize_NS_clean_data <- vroom(file = paste(filepath,"PopSize_NS.csv", sep = "/"))

```


## UK seafood supplies (g) 

Here, the cleaned data sheets are merged together.

```{r Check structure of individual data frames}
# Check column names of the data frames- should all be the same
colnames(df_captureProd_NS_clean_data)
colnames(df_aquaProd_Eurostat_clean_data)
colnames(df_trade_HMRC_clean_data)
colnames(df_housePurch_DEFRA_clean_data)
colnames(df_eatenOutPurch_DEFRA_clean_data)
colnames(df_consumption_NDNS_clean_data)
colnames(df_popSize_NS_clean_data)

df_trade_HMRC_clean_data$TemporalResolution <- "Annual"

```

```{r Combine data frames}
# rbind() cleaned data frames by column names
df_UKSeafoodSupplies <- rbind(df_captureProd_NS_clean_data, df_aquaProd_Eurostat_clean_data, df_trade_HMRC_clean_data, df_housePurch_DEFRA_clean_data, df_eatenOutPurch_DEFRA_clean_data, df_consumption_NDNS_clean_data)

df_UKSeafoodSupplies <- rbind(df_captureProd_NS_clean_data, df_aquaProd_Eurostat_clean_data, df_trade_HMRC_clean_data)


# Check structure of new data frame
str(df_UKSeafoodSupplies)

```


## UK seafood supplies (g/capita/ week)

The current data frame is displayed in grams. Create a new data frame where units are in grams/ capita/ week.

```{r UK seafood supplies per capita}
# Allocate population size to each year-- check
df_UKSeafoodSupplies$popsize <- df_popSize_NS_clean_data

# Calculate g/capita/week
df_UKSeafoodSupplies$value_gweek <- (df_UKSeafoodSupplies$Value / df_UKSeafoodSupplies$popsize) * 7 

```


Processed here:

```{r Load data}
# Read in UK population data 
df_NS_UK_pop_data <- vroom(file=paste(filepath,"PopSize_NS.csv", sep="/"))
colnames(df_NS_UK_pop_data)

# Select desired columns from data set
df_NS_UK_pop <- df_NS_UK_pop_data[c("CDID", "UKPOP")]

# Rename columns 
colnames(df_NS_UK_pop) <- c("Year", "UKPop")
str(df_NS_UK_pop)

```




```{r Calculate grams available per capita}
# Add in annual UK population data to the data frame as a new column. Duplicate population data for each year. 

# Match population size per year to each year in the merged seafood data frame
seafood_W_pop <- merge(UK_seafood_data, df_NS_UK_pop, by = "Year")

colnames(seafood_W_pop)

# Convert grams/year to g/capita/year
seafood_W_pop$ValueGramsCapitaYear <- seafood_W_pop$ValueGrams/seafood_W_pop$UKPop

# Convert grams/year to g/capita/week
seafood_W_pop$ValueGramsCapitaWeek<- seafood_W_pop$ValueGramsCapitaYear/52

df_UKseafood_200918 <- seafood_W_pop

# Separate g/capita/week data. Plan to 

```

