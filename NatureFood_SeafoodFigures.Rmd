---
title: "NatureFood_SeafoodFigures"
author: "Lofstedt, A."
date: "07-06-23"
output: powerpoint_presentation
---

Code for Nature Food figures only. 

### Preparation 

```{r Load libraries, include = FALSE}
# Load packages
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(plyr) # joins multiple data frames together
library(ggplot2) # makes plots fancier
library(scales) # displays integers on the axis
library(ggthemes) # contains extra themes, scales and functions for and related to ggplot2
library(gridExtra)
library(cowplot) # Plots two figures one output
library(fmsb) # for radar plots

```


```{r Edit chunk settings, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warninf = FALSE, 
  fig.height = 9, 
  fig.width = 16
)
```


```{r Setup default for figures, include=FALSE}
# Set default presentation of figures
theme_set(theme_bw()%+replace%
            theme(
              title = element_text(size = 26), 
              text = element_text(size = 30), 
              axis.text = element_text(size = 26, colour = "gray40"), # increase to make readable
              legend.key.size = unit(1.2, "cm"), 
              legend.title = element_text(size = 26), 
              legend.text = element_text(size = 24),
              panel.grid.major = element_line(colour= "gray40", linetype = "dotted", linewidth = 0.9), 
              panel.grid.minor = element_line(colour = "gray70", linetype = "dotted", linewidth = 0.7)
            ))
# instead of "size" can also use "linewidth"
```


```{r Set colour-blind palette}
# Colour-blind friendly palette with grey. Try to keep the order (http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette)
cbPalette <- c( "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")
#consumption, exports, imports, production, purchases, supplies

# Colours will be allocated in commodity alphabetical order. 
```


# Add in per capita per week 


```{r Load file path, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```

```{r Specify the desired file path}
filepath <- paste(data_dir,"Outputs/Databases", sep = "") 
# note we are able to change this to another file e.g. saving the output
```

```{r Load the seafood database}
# Load database 
df_UK_seafoodDB <- vroom(file=paste(filepath,"Seafood-database_preliminary.csv", sep="/"), na = c("NA"))

df_UK_seafoodDBNC <- vroom(file=paste(filepath,"Seafood-database-PCW_composition_preliminary.csv", sep="/"), na = c("NA"))
```



```{r Load population data}
#Specify the file path
filepath <- paste(data_dir,"ProcessedData", sep = "") 

# Load database 
df_UK_population <- vroom(file=paste(filepath,"UKPopulation_ONS_PreliminaryCleaned.csv", sep="/"), na = c("NA"))

# Simplify population data
df_UK_population_simp <- df_UK_population[c("Year", "UKPOP")]

```

```{r Merge SFDB with UK population}

df_UK_seafoodDB_Y <- merge(df_UK_seafoodDB, df_UK_population_simp, "Year")

```


```{r Changing volumne units to grams/capita/week}
# Calcualte g/capita/week
df_UK_seafoodDB_PCW <- 
  df_UK_seafoodDB_Y %>% 
  mutate(Volume = Volume/UKPOP/52, Units = "g/capita/week")

# Change structure of the database (short and wide)
# Aggregate value by commodity, year and species (production data composed of aquaculture and wild capture)
df_UK_seafoodDB_PCW_simp <- aggregate(Volume ~ Commodity + Year + Species + SpeciesType + SACN, data = df_UK_seafoodDB_PCW, sum)

# Need to unstack database to calculate seafood supplied. Change structure of the dataframe- convert to wide and short
df_UK_seafoodDB_PCW_short <- df_UK_seafoodDB_PCW_simp %>%
  pivot_wider(names_from = Commodity, values_from = Volume)

# Calculate seafood supplies whilst ignoring NA values
df_UK_seafoodDB_PCW_short <- df_UK_seafoodDB_PCW_short %>% 
  mutate(Supply = Production + Imports - Exports )
```



### Figure 1A. UK seafood supplies, consumption and purchases (g/capita/week) between 2009 and 2018.

```{r Seafood supplies consumption and purchases between 2009 and 2018}
# Subset desired variables 
df_UK_seafoodDB_PCW_shorter <- df_UK_seafoodDB_PCW_short[c("Supply", "Consumption", "Purchases", "Year", "Species", "SACN")]

# Change structure of the data set 
df_UK_seafoodDB_PCW_long <- melt(df_UK_seafoodDB_PCW_shorter, id.vars = c("Year", "Species", "SACN"), variable.name = "Commodity", value.name = "Volume")

# Aggregate data 
df_UK_seafoodDB_PCW_sum <- aggregate(Volume ~ Year + Commodity, data = df_UK_seafoodDB_PCW_long, sum)

# Plot total seafood supplied, purchases and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_seafoodDB_PCW_sum, aes(Year, Volume, fill= Commodity)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#E69F00", "#0072B2")) + # supplies, consumption, purchases
  theme(legend.title = element_blank()) 
  #theme(legend.position = "none")


```





### Figure 3. Total UK domestic UK seafood production (g/capita/week), bu species type between 2009 and 2018.

```{r Domestic seafood production}
# Subset production commodity 
df_UK_seafoodProduction_PCW <- df_UK_seafoodDB_PCW_short[c("Production", "Year", "Species", "SACN")]

# Sum UK seafood production, per SACN
df_UK_seafoodProduction_SACN <- aggregate(Production ~ SACN + Year, data = df_UK_seafoodProduction_PCW, sum)

# Select for lean and oily fish only
# Include "other" seafood types e.g. cephalopods and unknowns? 
df_UK_seafoodProduction_LOS <- subset(df_UK_seafoodProduction_SACN, SACN == "Lean" | SACN == "Oily" | SACN == "Shellfish")

df_UK_seafoodProduction_LOSO <- subset(df_UK_seafoodProduction_SACN, SACN == "Lean" | SACN == "Oily" | SACN == "Shellfish" 
                                        | SACN == "Other" )

# State order of the seafood types
df_UK_seafoodProduction_LOS$SACN_f <-  factor(df_UK_seafoodProduction_LOS$SACN, levels = c("Shellfish", "Lean", "Oily"))

df_UK_seafoodProduction_LOSO$SACN_f <-  factor(df_UK_seafoodProduction_LOSO$SACN, levels = c("Other", "Shellfish", 
                                                                                             "Lean", "Oily"))


# Plot average seafood supply (g/capita/week), to SACN level (lean and oily) between 2009 and 2018. 
ggplot(df_UK_seafoodProduction_LOSO, aes(y = Production, x = Year, fill = SACN_f)) +
  geom_bar(position = "stack", stat = "identity", color = "black", width = 0.5) + 
  scale_y_continuous(name = "Total seafood production (g/capita/week)") +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  scale_fill_manual(values = c("#999999", "#DDCC77",  "#CC79A7","#D55E00")) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2.0)

```




### Figure 5. Species contibutions to RNIs Nutrient supply, by species, in 2018. 

Key nutrients include calcium, iron, vitamin D, vitamin A, vitamin B12, iodine, selenium, omega-3 fatty acids and zinc.

```{r Calculate nutrient contributions to weekly recommended intakes}
# Read in data frame
str(df_all_nutrient_cleaned)

# Select specific variables and nutrients 
df_UK_seafoodDBNC <- df_all_nutrient_cleaned %>%  
  select(SeafoodSpecies, SACN, Nutrient, Volume) %>%
  filter(Nutrient == "TotalPUFA_g100g"| Nutrient == "Calcium_mg100g"| Nutrient == "Iron_mg100g"| 
         Nutrient == "VitaminD_µg100g"| Nutrient == "Zinc_mg100g")

# Calculate nutrient content in 280g of fish
df_UK_seafoodDBNC$Volume_PW <- df_UK_seafoodDBNC$Volume * 2.8
df_UK_seafoodDBNC$Nutrient <- as.character(df_UK_seafoodDBNC$Nutrient)

# Create a data frame of weekly RNIS
df_RNI_week <- data.frame(Nutrient = c("TotalPUFA_g100g", "Calcium_mg100g", "Iron_mg100g", 
                                       "VitaminD_µg100g",  "Zinc_mg100g"),
                       RNI_PW_MAX = c(112, 4900, 82.6, 70, 58.1), 
                       RNI_PW_MIN = c(0, 0, 0, 0, 0))

# Merge nutrient values and recommendations
df_nutrients_recs <- merge(df_UK_seafoodDBNC, df_RNI_week, by = "Nutrient")

# Calculate nutrient contribution 
df_nutrients_recs$nutrient_cont <- (df_nutrients_recs$Volume_PW / df_nutrients_recs$RNI_PW_MAX) * 100

```



```{r Create radar plots}
# Restructure data set (nutrients along the top )
# Need to unstack database to calculate seafood supplied. 
# Change structure of the dataframe- convert to wide and short
df_nutrients_recs_short <- df_nutrients_recs %>%
  select(Nutrient, SeafoodSpecies, nutrient_cont)  %>%
  pivot_wider(names_from = Nutrient, values_from = nutrient_cont) 
  
# Make first column row names
df_nutrients_recs_short<- df_nutrients_recs_short %>% 
  remove_rownames %>% 
  column_to_rownames(var="SeafoodSpecies")

# Advised nutrient intake
# Create data frame of max and min RNI's per week
# Average for males and females
df_max_min <- data.frame(
  TotalPUFA_g100g = c(100, 0), Calcium_mg100g = c(100, 0), Iron_mg100g = c(100, 0),
  VitaminD_µg100g = c(100, 0), Zinc_mg100g = c(100, 0)) 
rownames(df_max_min) <- c("Max", "Min") # State row names

colnames(df_nutrients_recs_short)


# Combine data frames by row
df_mainFish_NC <- rbind(df_max_min, df_nutrients_recs_short)

# Rename columns 
colnames(df_mainFish_NC) <- c("Total PUFA", "Calcium", "Iron", "VitaminD", "Zinc")
  
# Plot the data for one fish 
df_salmon <- df_mainFish_NC[c("Max", "Min", "Salmon"),]

# Create the radar charts
radarchart(df_salmon, axistype = 1, # custom polygon
    pcol = rgb(0.2,0.5,0.5,0.9) , pfcol = rgb(0.2,0.5,0.5,0.5) , plwd = 4 , 
    cglcol = "grey", cglty = 1, axislabcol="grey", caxislabels = seq(0,100,25), cglwd = 0.8,  #custom the grid
    vlcex = 1.5 #custom labels
    )

# Plot the data for one fish 
df_mackerel <- df_mainFish_NC[c("Max", "Min", "Mackerel"),]

# Create the radar charts
radarchart(df_mackerel, axistype = 1, # custom polygon
    pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4 , 
    cglcol = "grey", cglty = 1, axislabcol="grey", caxislabels = seq(0,100,25), cglwd = 0.8,  #custom the grid
    vlcex = 1.5 #custom labels
    )

# Plot the data for one fish 
df_herring <- df_mainFish_NC[c("Max", "Min", "Herring"),]

# Create the radar charts
radarchart(df_herring, axistype = 1, # custom polygon
    pcol = rgb(0.2,0.5,0.5,0.9) , pfcol = rgb(0.2,0.5,0.5,0.5) , plwd = 4 , 
    cglcol = "grey", cglty = 1, axislabcol="grey", caxislabels = seq(0,100,25), cglwd = 0.8,  #custom the grid
    vlcex = 1.5 #custom labels
    )


```








```{r Create radar plots}
## up to here

# Data needs to be structured in a certain way. First row: maximum values for each variable; 
# Second row: minimum values for each variable, Third row: Data for variables  

# Define the variable ranges: maximum and minimum for each nutrient. Set max to recommended RNI 
max_min <- data.frame(
  PUFA = c(20, 0), calcium = c(20, 0), Maths = c(20, 0),
  Sport = c(20, 0), English = c(20, 0), Geography = c(20, 0),
  Art = c(20, 0), Programming = c(20, 0), Music = c(20, 0)
) # change subject to nutrients
rownames(max_min) <- c("Max", "Min") # State row names

# Plot the data for one fish 
student1_data <- df[c("Max", "Min", "Student.1"), ]
radarchart(student1_data)

# Plot the data for three fish in the same plot

# Reduce plot margin using par()
op <- par(mar = c(1, 2, 2, 2))

# Create the radar charts
create_beautiful_radarchart(
  data = df, caxislabels = c(0, 5, 10, 15, 20), # state labels- change to nutrient values
  color = c("#00AFBB", "#E7B800", "#FC4E07") # States colors
)
# Add an horizontal legend 
legend(
  x = "bottom", legend = rownames(df[-c(1,2),]), horiz = TRUE,
  bty = "n", pch = 20 , col = c("#00AFBB", "#E7B800", "#FC4E07"),
  text.col = "black", cex = 1, pt.cex = 1.5
  )
par(op)
```





```{r Seafood supplies and consumption between 2009 and 2018}
# Subset desired variables 
df_UK_seafoodDB_PCW_CS <- df_UK_seafoodDB_PCW_short[c("Supply", "Consumption", "Year", "Species", "SACN")]

# Change structure of the data set 
df_UK_seafoodDB_PCW_CS_long <- melt(df_UK_seafoodDB_PCW_CS, id.vars = c("Year", "Species", "SACN"), variable.name = "Commodity", value.name = "Volume")

# Aggregate data 
df_UK_seafoodDB_PCW_CS_sum <- aggregate(Volume ~ Year + Commodity, data = df_UK_seafoodDB_PCW_CS_long, sum)

# Plot total seafood supplied and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_seafoodDB_PCW_CS_sum, aes(Year, Volume, fill= Commodity)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#E69F00")) + # supplies, consumption, 
  theme(legend.title = element_blank()) +
  theme(legend.position = "none")


# Select desired nutrients
df_UK_NC_NOI <- df_UK_NC_SOI %>%  
  select(Species, TotalPUFA_g100g, Calcium_mg100g, Iron_mg100g, VitaminD_µg100g, Zinc_mg100g) %>%
  group_by(Species) %>%
  filter(row_number()==1)
```




```{r filter data for figure 4}
df_figure_input <- df_SFDB_PCW_composition %>%  
  filter(Year == "2018", !SACN == "Other", !is.na(Production), !is.na(Imports), !is.na(Exports), !is.na(VitaminD_µg100g), !is.na(Zinc_mg100g), !is.na(TotalPUFA_g100g), !is.na(Calcium_mg100g), !is.na(Iron_mg100g)) %>% 
  mutate_if(is.character, factor) %>% 
  select(Species, Year, SpeciesType, SACN, Production, Exports, Imports, UKPOP, TotalPUFA_g100g, Calcium_mg100g, Iron_mg100g, VitaminD_µg100g, Zinc_mg100g)

```



```{r Calculate nutrient density score of each fish species}
# Divide nutrient (grams per 100 grams of food) by the recommended daily allowance (RDA) for that nutrient.

# Then divide calories (per 100 grams of the food) by the reference calorie intake (2,000 calories per day).

# Divide the RDA calculation by the calorie calculation
```

