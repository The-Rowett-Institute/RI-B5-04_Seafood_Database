---
title: "NatureFood_SeafoodFigures"
author: "Lofstedt, A."
date: "02-06-23"
output: powerpoint_presentation
---

Code for Nature Food figures only. 

### Preparation 

```{r Load libraries, include = FALSE}
# Load packages
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(plyr) # joins multiple data frames together
library(ggplot2) # makes plots fancier
library(scales) # displays integers on the axis
library(ggthemes) # contains extra themes, scales and functions for and related to ggplot2
library(gridExtra)
library(cowplot) # Plots two figures one output

```


```{r Edit chunk settings, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warninf = FALSE, 
  fig.height = 9, 
  fig.width = 16
)
```


```{r Setup default for figures, include=FALSE}
# Set default presentation of figures
theme_set(theme_bw()%+replace%
            theme(
              title = element_text(size = 26), 
              text = element_text(size = 30), 
              axis.text = element_text(size = 26, colour = "gray40"), # increase to make readable
              legend.key.size = unit(1.2, "cm"), 
              legend.title = element_text(size = 26), 
              legend.text = element_text(size = 24),
              panel.grid.major = element_line(colour= "gray40", linetype = "dotted", linewidth = 0.9), 
              panel.grid.minor = element_line(colour = "gray70", linetype = "dotted", linewidth = 0.7)
            ))
# instead of "size" can also use "linewidth"
```


```{r Set colour-blind palette}
# Colour-blind friendly palette with grey. Try to keep the order (http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette)
cbPalette <- c( "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")
#consumption, exports, imports, production, purchases, supplies

# Colours will be allocated in commodity alphabetical order. 
```


```{r Load file path, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```

```{r Specify the desired file path}
filepath <- paste(data_dir,"Outputs/Databases", sep = "") 
# note we are able to change this to another file e.g. saving the output
```

```{r Load the seafood database}
# Load database 
df_UK_seafoodDB_PCW <- vroom(file=paste(filepath,"Seafood-database_preliminary.csv", sep="/"), na = c("NA"))
```




```{r Calculate PCW }
# Merge database with UK population size


#
#UK_pop_2018 <- 66435600

#df_figure_input <- 
#  df_figure_input %>% 
#  mutate(Volume = Volume/UK_pop_2018/52, Units = "g/Capita/Week")
```



```{r filter database}

#df_UK_seafoodDB_commodities <- df_UK_seafoodDB %>%  
#  filter(Year == "2018", Commodity %in% c("Production", "Imports", "Exports")) %>% 
#  na.omit() %>% 
#  mutate_if(is.character, factor)

```


```{r Changing Volumne to grams/Capita/Week}
UK_pop_2018 <- 66435600

df_figure_input <- 
  df_figure_input %>% 
  mutate(Volume = Volume/UK_pop_2018/52, Units = "g/Capita/Week")

# Calculate seafood supplies whilst ignoring NA values
df_UK_seafoodDB_PCW_sum %>%
  rowwise() %>%  #rowwise will make sure the sum operation will occur on each row
  mutate(sum = sum(a,b,c, na.rm=TRUE)) #then a simple sum(..., na.rm=TRUE) is enough to result in what you need

#df_UK_suppCons_2018_sum <- na.omit(df_UK_suppCons_2018_sum) # Omit zero readings

```



### Figure 1A. UK seafood supplies, consumption and purchases (g/capita/week) between 2009 and 2018.

```{r Seafood supplies consumption and purchases between 2009 and 2018}
# Subset desired variables 
df_UK_seafoodDB_PCW_simp <- df_UK_seafoodDB_PCW[c("Supplies_pcw", "Consumption_pcw", "Purchases_pcw", "Year", "Species", "SACN")]

# Change structure of the data set 
df_UK_seafoodDB_PCW_long <- melt(df_UK_seafoodDB_PCW_simp, id.vars = c("Year", "Species", "SACN"), variable.name = "Commodity", value.name = "Volume")

# Aggregate data 
df_UK_seafoodDB_PCW_sum <- aggregate(Value ~ Species + SACN + Commodity, data = df_UK_seafoodDB_PCW_long, sum)

# Plot total seafood supplied and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_seafoodDB_PCW_sum, aes(Species, Volume, fill= Commodity)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#E69F00", "#0072B2")) + # supplies, consumption, purchases
  theme(legend.title = element_blank()) +
  theme(legend.position = "none")

```




### Figure 1B. UK seafood supplies and consumption (g/capita/week), by species, in 2018

```{r Seafood supplies and consumption between 2009 and 2018}
# Subset desired variables 
df_UK_seafoodDB_PCW_simp <- df_UK_seafoodDB_PCW[c("Supplies_pcw", "Consumption_pcw", "Year", "Species", "SACN")]

# Change structure of the data set 
df_UK_seafoodDB_PCW_long <- melt(df_UK_seafoodDB_PCW_simp, id.vars = c("Year", "Species", "SACN"), variable.name = "Commodity", value.name = "Volume")

# Aggregate data 
df_UK_seafoodDB_PCW_sum <- aggregate(Value ~ Species + SACN + Commodity, data = df_UK_seafoodDB_PCW_long, sum)

# Plot total seafood supplied and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_seafoodDB_PCW_sum, aes(Species, Volume, fill= Commodity)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#E69F00")) + # supplies, consumption, 
  theme(legend.title = element_blank()) +
  theme(legend.position = "none")

```



### Figure 3. Total UK domestic UK seafood production (g/capita/week), bu species type between 2009 and 2018.

```{r Domestic seafood production}
# Subset production commodity 
df_UK_seafoodProduction_PCW <- df_UK_seafoodDB_PCW[c("Production", "Year", "Species", "SACN")]

# Sum UK seafood production, per SACN
df_UK_seafoodProduction_SACN <- aggregate(Production ~ SACN + Year, data = df_UK_seafoodProduction_PCW, sum)

# Select for lean and oily fish only
# Include "other" seafood types e.g. cephalopods and unknowns? 
df_UK_seafoodProduction_LOS <- subset(df_UK_seafoodProduction_SACN, SACN == "Lean" | SACN == "Oily", SACN == "Shellfish")

# Plot average seafood supply (g/capita/week), to SACN level (lean and oily) between 2009 and 2018. 
ggplot(df_UK_seafoodProduction_LOS, aes(y = Production, x = Year, fill = SACN)) +
  geom_bar(position = "stack", stat = "identity", color = "black", width = 0.5) + 
  scale_y_continuous(name = "Total seafood production (g/capita/week)") +
  scale_x_discrete(name = "") +
  scale_fill_manual(values = c("#CC79A7", "#D55E00", "#999999"))+
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2.0)

```




### Figure 5. Species contibutions to RNIs Nutrient supply, by species, in 2018. 

Key nutrients include calcium, iron, vitamin D, vitamin A, vitamin B12, iodine, selenium, omega-3 fatty acids and zinc

Create radar chart  diagram of plots




```{r Calculate nutrient supplies from seafood  nutrient value by supplies}
# Multiply nutreint value (g/100g) bu seafood supplies (g/capita/day) and divide by 100. 

```






```{r Join data frame with translation document}
# Cleaned data set does not consider the status of the sample e.g. raw/ cooked. So new column created with such information.
# Duplicate species name column (duplicated column entries to be duplicated)
#df_seafoodCompSimp$SpeciesRevised <- df_seafoodCompSimp$SampleDescription

# Merge data frame with MCS data frame by species name
#df_seafoodCompSimp <- df_seafoodCompSimp %>% inner_join(., MCS_translations, by = c('SpeciesRevised' = 'MCS (DO NOT TOUCH)'))

# Check the structure
#str(df_seafoodCompSimp)
```




```{r Calculate nutrient density score of each fish species}

# Divide nutrient (grams per 100 grams of food) by the recommended daily allowance (RDA) for that nutrient.

# Then divide calories (per 100 grams of the food) by the reference calorie intake (2,000 calories per day).

# Divide the RDA calculation by the calorie calculation 

```

