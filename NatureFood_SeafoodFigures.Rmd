---
title: "NatureFood_SeafoodFigures"
author: "Lofstedt, A."
date: "28-06-23"
output: powerpoint_presentation
---

Code for Nature Food figures only. 

### Preparation 

```{r Load libraries, include = FALSE}
# Load packages
library(tidyr) # for tidying data
library(dplyr) # base R alternative but neater
library(vroom) # for loading and transforming data
library(tidyverse) # data exploration 
library(reshape2) # for melting data frames i.e. short and wide to long and thin
library(data.table) # for fread()-function
library(mice) # md.pattern to show missing data
library(plyr) # joins multiple data frames together
library(ggplot2) # makes plots fancier
library(scales) # displays integers on the axis
library(ggthemes) # contains extra themes, scales and functions for and related to ggplot2
library(gridExtra)
library(cowplot) # Plots two figures one output
library(fmsb) # for radar plots
library(ggpattern) # cross marking on plots

```


```{r Edit chunk settings, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warninf = FALSE, 
  fig.height = 9, 
  fig.width = 16
)
```


```{r Setup default for figures, include=FALSE}
# Set default presentation of figures
theme_set(theme_bw()%+replace%
            theme(
              title = element_text(size = 26), 
              text = element_text(size = 30), 
              axis.text = element_text(size = 26, colour = "black"), # increase to make readable
              legend.key.size = unit(1.2, "cm"), 
              legend.title = element_text(size = 26), 
              legend.text = element_text(size = 24),
              panel.grid.major = element_line(colour= "gray40", linetype = "dotted", linewidth = 0.9), 
              panel.grid.minor = element_line(colour = "gray70", linetype = "dotted", linewidth = 0.7)
            ))
# instead of "size" can also use "linewidth"
```


```{r Set colour-blind palette}
# Colour-blind friendly palette with grey. Try to keep the order (http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette)
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")
#consumption, exports, imports, production, purchases, supplies

# Colours will be allocated in commodity alphabetical order. 
```



```{r Load file path, echo=TRUE}
# Loading file path to the data into a value 
source("Data_filepath.R")# Data_filepath.R is listed in .gitignore-file. So, you will need to create that file yourself and provide your respected filepath using "data_dir <- [enter your here]"
```

```{r Specify the desired file path}
filepath <- paste(data_dir,"Outputs/Databases", sep = "") 
# note we are able to change this to another file e.g. saving the output
```

```{r Load the seafood database}
# Load database 
df_UK_seafoodDB <- vroom(file=paste(filepath,"Seafood-database_preliminary.csv", sep="/"), na = c("NA"))
```


```{r  Specify the desired file path}
#Specify the file path
filepath <- paste(data_dir,"ProcessedData", sep = "")
```

```{r Load population data}
# Load database 
df_UK_population <- vroom(file=paste(filepath,"UKPopulation_ONS_PreliminaryCleaned.csv", sep="/"), na = c("NA"))

# Simplify population data
df_UK_population_simp <- df_UK_population[c("Year", "UKPOP")]
```


```{r Merge SFDB with UK population}
df_UK_seafoodDB_Pop <- merge(df_UK_seafoodDB, df_UK_population_simp, "Year")
```


```{r Changing volumne units to grams/capita/week}
# Calcualte g/capita/week
df_UK_seafoodDB_PCW <- 
  df_UK_seafoodDB_Pop %>% 
  mutate(Volume = Volume/UKPOP/52, Units = "g/capita/week")

# Change structure of the database (short and wide)
# Aggregate value by commodity, year and species (production data composed of aquaculture and wild capture)
df_UK_seafoodDB_PCW_simp <- aggregate(Volume ~ Commodity + Year + Species + SpeciesType + SACN, data = df_UK_seafoodDB_PCW, sum)

# Need to unstack database to calculate seafood supplied. Change structure of the dataframe- convert to wide and short
df_UK_seafoodDB_PCW_short <- df_UK_seafoodDB_PCW_simp %>%
  pivot_wider(names_from = Commodity, values_from = Volume)

# Calculate seafood supplies whilst ignoring NA values
df_UK_seafoodDB_PCW_short <- df_UK_seafoodDB_PCW_short %>% 
  mutate(Supply = Production + Imports - Exports )

```



### Figure 2. UK seafood supplies, consumption and purchases (g/capita/week) between 2009 and 2018.

```{r Seafood supplies consumption and purchases between 2009 and 2018}
# Subset desired variables 
df_UK_seafoodDB_PCW_shorter <- df_UK_seafoodDB_PCW_short[c("Supply", "Consumption", "Purchases", "Year", "Species", "SACN")]

# Change structure of the data set 
df_UK_seafoodDB_PCW_long <- melt(df_UK_seafoodDB_PCW_shorter, id.vars = c("Year", "Species", "SACN"), variable.name = "Commodity", value.name = "Volume")

# Aggregate data 
df_UK_CPS_total <- aggregate(Volume ~ Year + Commodity, data = df_UK_seafoodDB_PCW_long, sum)

# Plot figure. Two option below- low to high or high to low
df_UK_CPS_total$Commodity_f <-  factor(df_UK_CPS_total$Commodity, levels = c("Consumption", "Purchases", "Supply"))

# Plot total seafood supplied, purchases and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_CPS_total, aes(Year, Volume, fill= Commodity_f)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#E69F00", "#0072B2", "#009E73")) + # supplies, consumption, purchases
  theme(legend.title = element_blank()) 
  #theme(legend.position = "none")
```


```{r Change order of bars}
# Convert to a factor
df_UK_CPS_total$Commodity_f <-  factor(df_UK_CPS_total$Commodity, levels = c("Supply", "Purchases", "Consumption"))

# Plot total seafood supplied, purchases and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_CPS_total, aes(Year, Volume, fill= Commodity_f)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#0072B2", "#E69F00")) + # supplies, consumption, purchases
  theme(legend.title = element_blank()) 
  #theme(legend.position = "none")
```


```{r Remove Y-axis title}
# Plot total seafood supplied, purchases and consumed (g/capita/week) between 2009 and 2018. 
ggplot(df_UK_CPS_total, aes(Year, Volume, fill= Commodity_f)) +
  geom_bar(position = "dodge", stat= "identity", color = "black") +
  scale_y_continuous(name = "", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#0072B2", "#E69F00")) + # supplies, consumption, purchases
  theme(legend.title = element_blank()) 
  #theme(legend.position = "none")


```



```{r Seafood supplies, purchases and consumption by fish type between 2009 and 2018}
# Create new column stating finfish and shellfish
df_UK_seafoodDB_PCW_trade_long_finfish <- subset(df_UK_seafoodDB_PCW_trade_long, SACN == "Lean" | 
                                                   SACN == "Oily" | Commodity == "Supply")
df_UK_seafoodDB_PCW_trade_long_finfish$SACNType <- "Finfish"

df_UK_seafoodDB_PCW_trade_long_OtherSeafood <- subset(df_UK_seafoodDB_PCW_trade_long, SACN == "Shellfish" | SACN == "Other")
df_UK_seafoodDB_PCW_trade_long_OtherSeafood$SACNType <- "OtherSeafood"

# Combine two data frames
df_UK_seafoodDB_PCW_long_SCANT <- rbind(df_UK_seafoodDB_PCW_trade_long_finfish,
                                        df_UK_seafoodDB_PCW_trade_long_OtherSeafood)

# Aggregate data 
df_UK_CPS_SACN_total <- aggregate(Volume ~ Year + Commodity + SACNType, 
                                  data = df_UK_seafoodDB_PCW_long_SCANT, sum)

# Convert into a factor
df_UK_CPS_SACN_total$Commodity_f <- factor(df_UK_CPS_SACN_total$Commodity, levels = c("Supply", "Purchases", "Consumption"))

df_UK_CPS_SACN_total$SACNType_f <- factor(df_UK_CPS_SACN_total$SACNType, levels = c("Finfish", "OtherSeafood"))

# Create a new data frame with just finfish supplies between 2009 and 2018
df_UK_seafoodDB_PCW_trade_long_finfish <- subset(df_UK_seafoodDB_PCW_trade_long, SACN == "Lean" | 
                                                   SACN == "Oily" | Commodity == "Supply")
# Aggregate data 
df_UK_finfish_supplies_total <- aggregate(Volume ~ Year, 
                                  data = df_UK_seafoodDB_PCW_trade_long_finfish, sum)


# Overlaying two plots
ggplot(df_UK_CPS_SACN_total) +
  geom_bar(aes(Year, Volume, fill = Commodity_f), position = "dodge", stat= "identity", color = "black") +
  geom_col_pattern(aes(Year, Volume, pattern_fill = SACNType_f), pattern = 'stripe', fill = "#009E73",
                   colour  = 'black', pattern_density = 0.15, pattern_spacing = 0.025, pattern_fill = "black", 
                   width = 0.3, position = position_nudge(x = -0.3)) +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#0072B2", "#E69F00")) + # supplies, consumption, purchases
  theme(legend.title = element_blank())
```


```{r Seafood supplies, purchases and consumption by fish type between 2009 and 2018}
# Create a new data frame with just finfish supplies between 2009 and 2018
df_UK_seafoodDB_PCW_trade_long_finfish <- subset(df_UK_seafoodDB_PCW_trade_long, SACN == "Lean" | 
                                                   SACN == "Oily" | Commodity == "Supply")
#df_UK_seafoodDB_PCW_trade_long_finfish$SACNType <- "Finfish"

# Aggregate data 
df_UK_finfish_supplies_total <- aggregate(Volume ~ Year, 
                                  data = df_UK_seafoodDB_PCW_trade_long_finfish, sum)

# Overlaying two plots
ggplot(df_UK_CPS_SACN_total) +
  geom_bar(aes(Year, Volume, fill = Commodity_f), position = "dodge", stat= "identity", color = "black") +
  geom_col_pattern(aes(Year, Volume, pattern_fill = SACNType_f), pattern = 'stripe', fill = "#009E73",
                   colour  = 'black', pattern_density = 0.15, pattern_spacing = 0.025, pattern_fill = "black", 
                   width = 0.3, position = position_nudge(x = -0.3)) +
  scale_y_continuous(name = "Amount of seafood (g/capita/week)", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = c("#009E73", "#0072B2", "#E69F00")) + # supplies, consumption, purchases
  theme(legend.title = element_blank())

```





### Figure 4. Total UK domestic production by species type between 2009 and 2018.

```{r Domestic seafood production}
# Subset production commodity 
df_UK_seafoodProduction <- df_UK_seafoodDB_PCW_short[c("Production", "Year", "Species", "SACN")]

# Sum UK seafood production, per SACN
df_UK_seafoodProduction_SACN <- aggregate(Production ~ SACN + Year, data = df_UK_seafoodProduction, sum)

# Select for lean and oily fish only
# Include "other" seafood types e.g. cephalopods and unknowns? 
#df_UK_seafoodProduction_LOS <- subset(df_UK_seafoodProduction_SACN, SACN == "Lean" | SACN == "Oily" | SACN == "Shellfish")

df_UK_seafoodProduction_LOSO <- subset(df_UK_seafoodProduction_SACN, SACN == "Lean" | SACN == "Oily" | SACN == "Shellfish" | SACN == "Other" )

# State order of the seafood types
#df_UK_seafoodProduction_LOS$SACN_f <-  factor(df_UK_seafoodProduction_LOS$SACN, levels = c("Shellfish", "Lean", "Oily"))

df_UK_seafoodProduction_LOSO$SACN_f <-  factor(df_UK_seafoodProduction_LOSO$SACN, levels = c("Other", "Shellfish", "Lean", "Oily"))

# Calculate total domestic prodcution per year
total_domestic <- aggregate(Production ~ Year, data = df_UK_seafoodProduction_LOSO, sum)

# Plot average seafood supply (g/capita/week), to SACN level (lean and oily) between 2009 and 2018. 
ggplot(df_UK_seafoodProduction_LOSO, aes(y = Production, x = Year, fill = SACN_f)) +
  geom_bar(position = "stack", stat = "identity", color = "black", width = 0.5) + 
  scale_y_continuous(name = "Total seafood production (g/capita/week)") +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  scale_fill_manual(values = c("#999999", "#DDCC77",  "#CC79A7","#D55E00")) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2.0) + 
  theme(legend.title = element_blank())
```


```{r Remove y axis}
# Plot average seafood supply (g/capita/week), to SACN level (lean and oily) between 2009 and 2018. 
ggplot(df_UK_seafoodProduction_LOSO, aes(y = Production, x = Year, fill = SACN_f)) +
  geom_bar(position = "stack", stat = "identity", color = "black", width = 0.5) + 
  scale_y_continuous(name = "", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  scale_fill_manual(values = c("#999999", "#DDCC77",  "#CC79A7","#D55E00")) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2.0) + 
  theme(legend.title = element_blank())

```


### Estimating seafood waste at a household level 

```{r Estimate seafood waste at a household level (purchases less consumption)}
# Calculate seafood waste
df_UK_seafoodDB_PCW_short$Waste <- df_UK_seafoodDB_PCW_short$Purchases - df_UK_seafoodDB_PCW_short$Consumption

# Aggregate data 
df_UK_seafoodWaste <- aggregate(Waste ~ Year, data = df_UK_seafoodDB_PCW_short, sum)

summary(df_UK_seafoodWaste)

# Plot seafood waste
ggplot(df_UK_seafoodWaste, aes(Year, Waste)) +
  geom_bar(position = "stack", stat= "identity", color = "black") +
  scale_y_continuous(name = "Seafood waste(g/capita/week)", limits = c(0,300)) +
  scale_x_continuous(name = "Year", breaks = seq(2009, 2018, 1), 
                     guide = guide_axis(angle = 45)) +
  geom_hline(yintercept = 280, linetype = "dashed", color = "red", linewidth = 2) +
  scale_fill_manual(values = "#CC79A7") + 
  theme(legend.title = element_blank()) 

```



